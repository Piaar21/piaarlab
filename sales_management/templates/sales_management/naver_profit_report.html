{% extends 'naver_sales_management_base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 class="mb-4 text-primary">순수익 리포트 (네이버)</h2>
  <!-- KPI 카드 탭 영역 -->
  <div class="row mb-4">
    <div class="col-12">
      <!-- 탭 버튼 -->
      <div class="kpi-tabs mb-2">
        <button class="kpi-tab-btn btn btn-outline-primary active" data-tab="margin-low">마진 -1% 이하</button>
        <button class="kpi-tab-btn btn btn-outline-primary" data-tab="profit-high">순수익 +1만원 이상</button>
        <button class="kpi-tab-btn btn btn-outline-primary" data-tab="profit-low">순수익 -1만원 이하</button>
      </div>
      <!-- 탭 콘텐츠 -->
      <div class="kpi-tab-content">
        <!-- 마진 -1% 이하 탭 -->
        <div id="margin-low" class="kpi-card">
          {% if kpi_margin_low %}
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 0)" style="cursor:pointer;">
                    상품명 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 1)" style="cursor:pointer;">
                    구분 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 2)" style="cursor:pointer;">
                    판매수량 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 3)" style="cursor:pointer;">
                    광고판매 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 4)" style="cursor:pointer;">
                    순매출 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 5)" style="cursor:pointer;">
                    광고비 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 6)" style="cursor:pointer;">
                    매입가 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 7)" style="cursor:pointer;">
                    순수익 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 8)" style="cursor:pointer;">
                    마진 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for item in kpi_margin_low %}
                  <tr>
                    <td class="one-line">{{ item.product_name }}</td>
                    <td class="one-line">{{ item.store }}</td>
                    <td class="text-nowrap">{{ item.qty|intcomma }}</td>
                    <td class="text-nowrap">{{ item.ad_qty|intcomma }}</td>
                    <td class="text-nowrap">{{ item.net_sales_amount|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.ad_spend|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.purchase_cost|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.profit|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.margin_rate|floatformat:2 }}%</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="mb-0">해당 조건의 데이터가 없습니다.</p>
          {% endif %}
        </div>
        <!-- 순수익 +1만원 이상 탭 -->
        <div id="profit-high" class="kpi-card" style="display:none;">
          {% if kpi_profit_high %}
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 0)" style="cursor:pointer;">
                    상품명 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 1)" style="cursor:pointer;">
                    구분 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 2)" style="cursor:pointer;">
                    판매수량 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 3)" style="cursor:pointer;">
                    광고판매 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 4)" style="cursor:pointer;">
                    순매출 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 5)" style="cursor:pointer;">
                    광고비 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 6)" style="cursor:pointer;">
                    매입가 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 7)" style="cursor:pointer;">
                    순수익 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 8)" style="cursor:pointer;">
                    마진 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for item in kpi_profit_high %}
                  <tr>
                    <td class="one-line">{{ item.product_name }}</td>
                    <td class="one-line">{{ item.store }}</td>
                    <td class="text-nowrap">{{ item.qty|intcomma }}</td>
                    <td class="text-nowrap">{{ item.ad_qty|intcomma }}</td>
                    <td class="text-nowrap">{{ item.net_sales_amount|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.ad_spend|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.purchase_cost|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.profit|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.margin_rate|floatformat:2 }}%</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="mb-0">해당 조건의 데이터가 없습니다.</p>
          {% endif %}
        </div>
        <!-- 순수익 -1만원 이하 탭 -->
        <div id="profit-low" class="kpi-card" style="display:none;">
          {% if kpi_profit_low %}
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 0)" style="cursor:pointer;">
                    상품명 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 1)" style="cursor:pointer;">
                    구분 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 2)" style="cursor:pointer;">
                    판매수량 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 3)" style="cursor:pointer;">
                    광고판매 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 4)" style="cursor:pointer;">
                    순매출 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 5)" style="cursor:pointer;">
                    광고비 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 6)" style="cursor:pointer;">
                    매입가 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 7)" style="cursor:pointer;">
                    순수익 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                  <th class="text-nowrap" onclick="sortTableGlobal(this, 8)" style="cursor:pointer;">
                    마진 <i class="sort-arrow bi bi-arrow-down-up"></i>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for item in kpi_profit_low %}
                  <tr>
                    <td class="one-line">{{ item.product_name }}</td>
                    <td class="one-line">{{ item.store }}</td>
                    <td class="text-nowrap">{{ item.qty|intcomma }}</td>
                    <td class="text-nowrap">{{ item.ad_qty|intcomma }}</td>
                    <td class="text-nowrap">{{ item.net_sales_amount|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.ad_spend|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.purchase_cost|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.profit|floatformat:0|intcomma }} 원</td>
                    <td class="text-nowrap">{{ item.margin_rate|floatformat:2 }}%</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="mb-0">해당 조건의 데이터가 없습니다.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- 날짜 범위 필터 및 매입가 업데이트 -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-start align-items-center gap-3 flex-wrap">
        <form method="GET" action="" id="filterForm" class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('today')">오늘</button>
          <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('7days')">7일</button>
          <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('30days')">30일</button>
          <div class="d-flex align-items-center">
            <input type="date" name="start_date" id="start_date" class="form-control" style="width:auto;" value="{{ start_date|date:'Y-m-d'|default_if_none:'' }}"/>
            <span class="mx-2">~</span>
            <input type="date" name="end_date" id="end_date" class="form-control" style="width:auto;" value="{{ end_date|date:'Y-m-d'|default_if_none:'' }}"/>
          </div>
          <button type="submit" class="btn btn-sm btn-secondary">적용</button>
        </form>
        <form method="POST" action="{% url 'naver_update_cost_profit_report' %}" id="updateCostsForm" class="d-flex align-items-center gap-2">
          {% csrf_token %}
          <input type="hidden" name="fetch_start_date" value="{{ start_date|date:'Y-m-d'|default_if_none:'' }}" />
          <input type="hidden" name="fetch_end_date"   value="{{ end_date|date:'Y-m-d'|default_if_none:'' }}" />
          <button type="submit" class="btn btn-sm btn-primary">매입가 업데이트</button>
        </form>
        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#checkCostModal">매입가 확인</button>

      </div>
    </div>
  </div>

  <!-- 리포트 테이블 (일자별 소계) -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle w-100">
          <thead>
            <tr style="background-color: #dfe6e9;">
              <th class="left-header-col1">일자</th>
              <th class="left-header-col2 text-center">구분</th>
              <th class="text-center">판매수량</th>
              <th class="text-center">광고판매수량</th>
              <th class="text-center">순매출</th>
              <th class="text-center">수수료</th>
              <th class="text-center">광고집행비</th>
              <th class="text-center">매입가</th>
              <th class="text-center">기타비용</th>
              <th class="text-center">순수익</th>
              <th class="text-center">마진률</th>
            </tr>
          </thead>
          <tbody>
            <!-- 전체 기간 합계 행 -->
            <tr class="fw-bold product-row" style="background-color: #f0f0f0;">
              <td class="left-col1">
                <button type="button" class="btn btn-sm btn-outline-primary toggle-btn" data-idx="period">+</button>
                전체 기간
              </td>
              <td class="left-col2 text-center">
                소계
                <span class="text-primary show-modal-icon ms-2" style="cursor: pointer;" data-date="period">
                  <i class="fas fa-info-circle"></i>
                </span>
              </td>
              <td class="text-end">{{ period_summary.total_qty|intcomma }}</td>
              <td class="text-end">{{ period_summary.total_ad_qty|intcomma }}</td>
              <td class="text-end">{{ period_summary.net_sales_amount|intcomma }} 원</td>
              <td class="text-end">{{ period_summary.commission|floatformat:0|intcomma }} 원</td>
              <td class="text-end">{{ period_summary.ad_spend|floatformat:0|intcomma }} 원</td>
              <td class="text-end">{{ period_summary.purchase_cost|intcomma }} 원</td>
              <td class="text-end">{{ period_summary.etc_cost|intcomma }} 원</td>
              <td class="text-end">{{ period_summary.profit|floatformat:0|intcomma }} 원</td>
              <td class="text-end">
                {% if period_summary.net_sales_amount > 0 %}
                  {{ period_summary.margin_rate|floatformat:2 }}%
                {% else %}
                  0%
                {% endif %}
              </td>
            </tr>
            <!-- 전체 기간 상세 하위 행 (토글 대상) -->
            {% if period_summary.brand_details %}
            {% for brand, detail in period_summary.brand_details.items %}
              <tr data-parent-idx="period" style="display:none;">
                <td colspan="2">└ {{ brand }}</td>
                <td class="text-end">{{ detail.qty|intcomma }}</td>
                <td class="text-end">{{ detail.ad_qty|intcomma }}</td>
                <td class="text-end">{{ detail.net_sales_amount|floatformat:0|intcomma }} 원</td>
                <td class="text-end">{{ detail.commission|floatformat:0|intcomma }} 원</td>
                <td class="text-end">{{ detail.ad_spend|floatformat:0|intcomma }} 원</td>
                <td class="text-end">{{ detail.purchase_cost|floatformat:0|intcomma }} 원</td>
                <td class="text-end">{{ detail.etc_cost|floatformat:0|intcomma }} 원</td>
                <td class="text-end">{{ detail.profit|floatformat:0|intcomma }} 원</td>
                <td class="text-end">
                  {% if detail.net_sales_amount > 0 %}
                    {{ detail.margin_rate|floatformat:2 }}%
                  {% else %}
                    0%
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr data-parent-idx="period">
              <td colspan="11" class="text-center">해당 기간에 대한 상세 데이터가 없습니다.</td>
            </tr>
          {% endif %}

            <!-- 일자별 데이터 -->
            {% for day in daily_reports %}
              <tr class="fw-bold product-row">
                <td class="left-col1">
                  <button type="button" class="btn btn-sm btn-outline-primary toggle-btn" data-idx="{{ forloop.counter }}">+</button>
                  {{ day.date_str }}
                </td>
                <td class="left-col2 text-center">
                  소계
                  <span class="text-primary show-modal-icon ms-2" style="cursor: pointer;" data-date="{{ day.date_str }}">
                    <i class="fas fa-info-circle"></i>
                  </span>
                </td>
                <td class="text-end">{{ day.qty|intcomma }}</td>
                <td class="text-end">{{ day.ad_qty|intcomma }}</td>
                <td class="text-end">{{ day.net_sales_amount|intcomma }} 원</td>
                <td class="text-end">{{ day.commission|floatformat:0|intcomma }} 원</td>
                <td class="text-end">{{ day.ad_spend|floatformat:0|intcomma }} 원</td>
                <td class="text-end">{{ day.purchase_cost|intcomma }} 원</td>
                <td class="text-end">{{ day.etc_cost|intcomma }} 원</td>
                <td class="text-end">{{ day.profit|floatformat:0|intcomma }} 원</td>
                <td class="text-end">
                  {% if day.net_sales_amount > 0 %}
                    {{ day.margin_rate|floatformat:2 }}%
                  {% else %}
                    0%
                  {% endif %}
                </td>
              </tr>
              {% for det in day.details %}
                <tr style="display:none;" data-parent-idx="{{ forloop.parentloop.counter }}">
                  <td class="left-col1" colspan="2">└ {{ det.kind }}</td>
                  <td class="text-end">{{ det.qty|intcomma }}</td>
                  <td class="text-end">{{ det.ad_qty|intcomma }}</td>
                  <td class="text-end">{{ det.net_sales_amount|intcomma }} 원</td>
                  <td class="text-end">{{ det.commission|floatformat:0|intcomma }} 원</td>
                  <td class="text-end">{{ det.ad_spend|intcomma }} 원</td>
                  <td class="text-end">{{ det.purchase_cost|intcomma }} 원</td>
                  <td class="text-end">{{ det.etc_cost|intcomma }} 원</td>
                  <td class="text-end">{{ det.profit|floatformat:0|intcomma }} 원</td>
                  <td class="text-end">
                    {% if det.net_sales_amount > 0 %}
                      {{ det.margin_rate|floatformat:2 }}%
                    {% else %}
                      0%
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 모달 영역: 일자별 상품 상세 모달 -->
<div class="modal fade" id="detailModalDaily" tabindex="-1" aria-labelledby="detailModalDailyLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 100% !important;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalDailyLabel">일자별 상품 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modal-content-area-daily">
          <p>선택한 날짜의 상품 상세 정보가 여기에 표시됩니다.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 모달 영역: 전체기간 상품 상세 모달 -->
<div class="modal fade" id="detailModalOverall" tabindex="-1" aria-labelledby="detailModalOverallLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 100% !important;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalOverallLabel">전체기간 상품 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modal-content-area-overall">
          <p>전체기간의 상품 상세 정보가 여기에 표시됩니다.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 매입가 확인 모달 -->
<div class="modal fade" id="checkCostModal" tabindex="-1" aria-labelledby="checkCostModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="checkCostModalLabel">매입가 0 옵션 확인</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if zero_purchase_list %}
          <table class="table table-sm">
            <thead>
              <tr>
                <th>상품명</th>
                <th>옵션명</th>
                <th>옵션코드</th>
                <th>매입가</th>
              </tr>
            </thead>
            <tbody>
              {% for item in zero_purchase_list %}
                <tr>
                  <td class="one-line">{{ item.product_name }}</td>
                  <td class="one-line">{{ item.option_name }}</td>
                  <td class="one-line">{{ item.option_code }}</td>
                  <td class="text-end">{{ item.purchasing_price|intcomma }} 원</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>해당 기간에 매입가가 0인 옵션이 없습니다.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<script>
  // JSON 파싱 전에 값이 있는지 확인 (빈 문자열이면 '{}' 사용)
  const dayProductsMap = JSON.parse('{{ day_products_map_json|default:"{}"|escapejs|safe }}');
  const overallProductsMap = JSON.parse('{{ overall_products_map_json|default:"{}"|escapejs|safe }}');

  // 디버깅: 파싱된 데이터를 콘솔에 출력
  console.log("dayProductsMap:", dayProductsMap);
  console.log("overallProductsMap:", overallProductsMap);

  document.addEventListener('DOMContentLoaded', () => {
    // (1) 일자별 모달 토글 버튼 이벤트
    const toggleButtons = document.querySelectorAll('.toggle-btn');
    toggleButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const idx = btn.dataset.idx;
        console.log("[Toggle] idx:", idx);
        const subRows = document.querySelectorAll(`tr[data-parent-idx="${idx}"]`);
        subRows.forEach(row => {
          row.style.display = (row.style.display === 'none' || row.style.display === '') ? 'table-row' : 'none';
        });
        btn.textContent = (btn.textContent.trim() === '+') ? '-' : '+';
      });
    });

    // (2) 모달 아이콘 이벤트 처리
    const iconButtons = document.querySelectorAll('.show-modal-icon');
    const detailModalDailyEl = document.getElementById('detailModalDaily');
    const detailModalOverallEl = document.getElementById('detailModalOverall');

    const detailModalDaily = detailModalDailyEl ? new bootstrap.Modal(detailModalDailyEl) : null;
    const detailModalOverall = detailModalOverallEl ? new bootstrap.Modal(detailModalOverallEl) : null;

    iconButtons.forEach(icon => {
      icon.addEventListener('click', (event) => {
        const dateValue = event.currentTarget.dataset.date;
        console.log("[Modal Icon Clicked] dateValue:", dateValue);
        let modalLabelText = (dateValue === 'period') ? '전체 기간 상품 상세' : `${dateValue} 상품 상세`;
        if(dateValue === 'period'){
          const modalLabel = document.getElementById('detailModalLabelOverall') || document.getElementById('detailModalLabel');
          if(modalLabel) {
            modalLabel.innerText = modalLabelText;
          }
          const overallHTML = buildModalDetailTable(overallProductsMap, "전체 기간");
          const contentArea = document.getElementById('modal-content-area-overall');
          if(contentArea) {
            contentArea.innerHTML = overallHTML;
          }
          console.log("[Modal] Showing overall modal with HTML:", overallHTML);
          if(detailModalOverall) {
            detailModalOverall.show();
          }
        } else {
          const modalLabel = document.getElementById('detailModalLabelDaily') || document.getElementById('detailModalLabel');
          if(modalLabel) {
            modalLabel.innerText = modalLabelText;
          }
          const dailyData = dayProductsMap[dateValue];
          const dailyHTML = buildModalDetailTable(dailyData, dateValue);
          const contentArea = document.getElementById('modal-content-area-daily');
          if(contentArea) {
            contentArea.innerHTML = dailyHTML;
          }
          console.log("[Modal] Showing daily modal with HTML:", dailyHTML);
          if(detailModalDaily) {
            detailModalDaily.show();
          }
        }
      });
    });

    // (6) KPI 탭 전환 이벤트
    const tabButtons = document.querySelectorAll('.kpi-tab-btn');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', function(){
        tabButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const kpiCards = document.querySelectorAll('.kpi-card');
        kpiCards.forEach(card => card.style.display = 'none');
        const targetTab = this.getAttribute('data-tab');
        const targetElement = document.getElementById(targetTab);
        if(targetElement) {
          targetElement.style.display = 'block';
        }
        console.log("[KPI Tab] Activated tab:", targetTab);
      });
    });
  });

  function buildModalDetailTable(data, dateValue) {
    let html = `<h5 class="mb-3">${dateValue} 상품별 상세</h5>`;
    html += `
      <div class="table-responsive">
        <table class="table table-sm table-bordered modal-detail-table">
          <thead>
            <tr style="background-color: #dfe6e9;">
              <th onclick="sortModalTable(this, 0)" style="cursor:pointer;">상품ID <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 1)" style="cursor:pointer;">상품명 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 2)" style="cursor:pointer;">판매수량 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 3)" style="cursor:pointer;">광고판매수량 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 4)" style="cursor:pointer;">순매출 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 5)" style="cursor:pointer;">수수료 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 6)" style="cursor:pointer;">광고집행비 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 7)" style="cursor:pointer;">매입가 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 8)" style="cursor:pointer;">기타비용 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 9)" style="cursor:pointer;">순수익 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
              <th onclick="sortModalTable(this, 10)" style="cursor:pointer;">마진률 <i class="sort-arrow bi bi-arrow-down-up"></i></th>
            </tr>
          </thead>
          <tbody>
    `;
    
    if (!data || Object.keys(data).length === 0) {
      html += `<tr><td colspan="11" class="text-center">해당 데이터가 없습니다.</td></tr>`;
    } else {
      for (let pid in data) {
        let row = data[pid];
        let marginRate = Number(row.margin_rate);
        if (!isFinite(marginRate) || isNaN(marginRate)) {
          marginRate = 0;
        }
        html += `
          <tr>
            <td>${row.product_id}</td>
            <td>${row.product_name || '(이름없음)'}</td>
            <td class="text-end">${formatNumber(row.sold_qty)}</td>
            <td class="text-end">${formatNumber(row.ad_qty)}</td>
            <td class="text-end">${formatNumber(row.sales_amt)} 원</td>
            <td class="text-end">${formatNumber(row.commission)} 원</td>
            <td class="text-end">${formatNumber(row.ad_spend)} 원</td>
            <td class="text-end">${formatNumber(row.purchase_cost)} 원</td>
            <td class="text-end">${formatNumber(row.etc_cost)} 원</td>
            <td class="text-end">${formatNumber(row.profit)} 원</td>
          <td class="text-end">${Number(row.margin_rate).toFixed(1)}%</td>
        </tr>
      `;
    }
  }
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  return html;
}

  function formatNumber(num) {
    if (isNaN(num)) return '0';
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // (4) 모달 테이블 정렬 함수
  function sortModalTable(th, colIndex){
    const table = th.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    let sortOrder = th.dataset.sortOrder === "asc" ? "desc" : "asc";
    th.dataset.sortOrder = sortOrder;
    
    rows.sort((rowA, rowB) => {
      const cellA = rowA.querySelectorAll('td')[colIndex]?.innerText.trim() || '';
      const cellB = rowB.querySelectorAll('td')[colIndex]?.innerText.trim() || '';
      const numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ''));
      const numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ''));
      if (!isNaN(numA) && !isNaN(numB)) {
        return sortOrder === 'asc' ? numA - numB : numB - numA;
      }
      return sortOrder === 'asc'
        ? cellA.localeCompare(cellB)
        : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  }

  // (5) 기간 설정 함수
  function setDateRange(mode){
    const today = new Date();
    let start = new Date();
    let end = new Date();
    if(mode === 'today'){
      start = today;
      end = today;
    } else if(mode === '7days'){
      start.setDate(today.getDate() - 7);
    } else if(mode === '30days'){
      start.setDate(today.getDate() - 30);
    }
    document.getElementById('start_date').value = start.toISOString().split('T')[0];
    document.getElementById('end_date').value = end.toISOString().split('T')[0];
  }
</script>

<style>
  .container-fluid {
    margin-left: 16rem;
    width: calc(100% - 16rem);
  }
  .card {
    border: none;
    border-radius: 15px;
    background-color: #fff;
    padding: 20px;
  }
  .table td, .table th {
    padding: 12px;
    vertical-align: middle;
    border: 1px solid #dfe6e9;
    white-space: nowrap;
  }
  .table-responsive {
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: auto;
  }
  .product-row {
    background-color: #fff;
  }
  thead tr:nth-child(1) th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #dfe6e9;
  }
  thead tr:nth-child(2) th {
    position: sticky;
    top: 49px;
    z-index: 10;
    background-color: #f0f0f0;
  }
  .sort-arrow {
    font-size: 0.8rem;
    margin-left: 0.3rem;
  }
  .kpi-tabs {
    display: flex;
    gap: 10px;
  }
  .kpi-tab-btn {
    flex: 1;
  }
  .kpi-tab-btn.active {
    background-color: #0d6efd;
    color: #fff;
  }
  .kpi-card {
    max-height: 300px;
    overflow-y: auto;
  }
  .one-line {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
{% endblock %}