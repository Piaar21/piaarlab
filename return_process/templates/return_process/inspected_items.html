{% extends 'return_process_base.html' %}
{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4 text-primary">검수완료 목록</h2>

    <!-- 사유(검수결과) 및 노트 일괄 적용 영역 시작 -->
    <div class="d-flex align-items-center mb-3">
        <span class="ms-2">
            선택된 항목: <strong id="selected-count">0</strong>개
          </span>
        <div class="btn-group me-3">
            <button class="btn btn-outline-danger reason-btn" data-reason="오배송">오배송</button>
            <button class="btn btn-outline-success reason-btn" data-reason="이상없음">이상없음</button>
            <button class="btn btn-outline-warning reason-btn" data-reason="파손및불량">파손및불량</button>
            <button class="btn btn-outline-info reason-btn" data-reason="보류">보류</button>
        </div>

        <input type="text" class="form-control w-auto" id="input-note" placeholder="사유(특이사항) 입력">
        <button class="btn btn-primary ms-2" id="apply-reason">사유 일괄 적용</button>
    </div>
    <!-- 사유(검수결과) 및 노트 일괄 적용 영역 끝 -->

    <div class="card shadow-sm">
        <div class="card-body">
            <form id="return-form">
                {% csrf_token %}
                <button type="button" class="btn btn-secondary mb-3" id="back-to-collected-btn">수거완료 상태로 되돌리기</button>
                <button type="button" class="btn btn-primary mb-3" id="approve-return-btn">반품승인</button>
                <button type="button" class="btn btn-info mb-3" id="send-sms-btn">배송비문자</button>
                <button type="button" class="btn btn-warning mb-3" id="update-product-order-status">현재 클레임상태 업데이트</button>
                <button type="button" class="btn btn-info mb-3" id="btn-claim-type-return">클레임종류→RETURN</button>
                <button type="button" class="btn btn-info mb-3" id="btn-claim-type-exchange">클레임종류→EXCHANGE</button>
                <button type="button" class="btn btn-warning mb-3" id="exchange-dispatch-btn">교환재배송</button>
                <button type="button" class="btn btn-success mb-3" id="copy-order-numbers-btn">주문번호 복사</button>
                <button type="button" class="btn btn-success mb-3" id="export-excel-btn">엑셀 다운로드</button>


                <!-- 필터 영역 시작 -->
                <div class="d-flex mb-3 gap-3 align-items-center">
                    <!-- 검수 결과 필터 -->
                    <div>
                        <label for="issue-filter" class="form-label me-2">검수 결과:</label>
                        <select id="issue-filter" class="form-select w-auto">
                            <option value="">전체</option>
                            <option value="미검수">미검수</option>
                            <option value="오배송">오배송</option>
                            <option value="이상없음">이상없음</option>
                            <option value="파손및불량">파손및불량</option>
                            <option value="보류">보류</option>
                        </select>
                    </div>

                    <!-- 클레임 사유 필터 -->
                    <div>
                        <label for="reason-filter" class="form-label me-2">클레임 사유:</label>
                        <select id="reason-filter" class="form-select w-auto">
                            <option value="">전체</option>
                            <option value="N/A">N/A</option>
                            <option value="고객변심">고객변심</option>
                            <option value="오배송">오배송</option>
                            <option value="상품 불량">상품 불량</option>
                            <option value="주문 실수">주문 실수</option>
                            <option value="단순 변심">단순 변심</option>
                        </select>
                    </div>
                    <div>
                        <label for="claim-type-filter" class="form-label me-2">클레임 종류:</label>
                        <select id="claim-type-filter" class="form-select w-auto">
                            <option value="">전체</option>
                            <!-- 실제로 DB에 들어가는 값들에 맞춰 options 작성 -->
                            <option value="RETURN">RETURN</option>
                            <option value="EXCHANGE">EXCHANGE</option>
                            <option value="반품">반품</option>
                            <option value="교환">교환</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </div>
                </div>

                
                <!-- 필터 영역 끝 -->

                <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                    <table class="table table-hover table-striped align-middle" id="items-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>검수 결과</th>
                                <th>톡톡</th>
                                <th>현재클레임상태</th>
                                <th>클레임 종류</th>
                                <th>클레임 사유</th>
                                <th>고객 사유</th>
                                <th style="width:400px !important;">사유</th>
                                <th>수거 송장번호</th>
                                <th>수거 배송비</th>
                                <th>배송비 지급 방식</th>
                                <th>주문번호</th>
                                <th>스토어명</th>
                                <th>수취인명</th>
                                <th>연락처</th>
                                <th>옵션코드</th>
                                <th>상품명</th>
                                <th>옵션명</th>
                                <th>수량</th>
                                <th>배송 완료일</th>
                                <th>클레임 요청일</th>

                                <th>업데이트날짜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr data-product_issue="{{ item.product_issue|default:'미검수' }}"
                                data-claim_type="{{ item.claim_type|default:'N/A' }}"
                                data-claim_reason="{{ item.claim_reason|default:'N/A' }}"
                                data-customer_reason="{{ item.customer_reason|default:'N/A' }}"
                                data-note="{{ item.note|default:' ' }}"
                                data-collect_tracking_number="{{ item.collect_tracking_number|default:'N/A' }}"
                                data-return_shipping_charge="{{ item.return_shipping_charge|default:'0' }}"
                                data-shipping_charge_payment_method="{{ item.shipping_charge_payment_method|default:'N/A' }}"
                                data-order_number="{{ item.order_number }}"
                                data-store_name="{{ item.store_name|default:'N/A' }}"
                                data-recipient_name="{{ item.recipient_name|default:'N/A' }}"
                                data-recipient_contact="{{ item.recipient_contact|default:'N/A' }}"
                                data-option_code="{{ item.option_code|default:'N/A' }}"
                                data-product_name="{{ item.product_name|default:'N/A' }}"
                                data-option_name="{{ item.option_name|default:'N/A' }}"
                                data-quantity="{{ item.quantity|default:'0' }}">
                                <td><input type="checkbox" class="row-checkbox" name="item_ids" value="{{ item.id }}"></td>
                                <td class="issue-cell">{{ item.product_issue|default:"미검수" }}</td>
                                <td>
                                    {% if item.store_name in store_code_map_keys %}
                                      <button type="button" 
                                              class="btn btn-primary talk-btn" 
                                              data-order="{{ item.order_number }}" 
                                              data-store="{{ item.store_name }}"
                                              onclick="openTalkChat('{{ item.order_number }}','{{ item.store_name }}')">
                                        톡톡하기
                                      </button>
                                      
                                    {% else %}
                                      <span class="text-danger fw-bold">미지원</span>
                                    {% endif %}
                                </td>
                                <td class="product-order-status-cell">{{ item.product_order_status|default:"N/A" }}</td>
                                <td>{{ item.claim_type|default:"N/A" }}</td>
                                <td class="reason-cell">{{ item.claim_reason|default:"N/A" }}</td>
                                <td>{{ item.customer_reason|default:"N/A" }}</td>
                                <td>{{ item.note|default:" " }}</td>
                                <td class="collect-tracking">{{ item.collect_tracking_number|default:"N/A" }}</td>
                                <td>{{ item.return_shipping_charge|default:"0" }}</td>
                                <td>{{ item.shipping_charge_payment_method|default:"N/A" }}</td>
                                <td class="order-number-cell text-primary" style="cursor:pointer;">
                                    {% if item.platform|lower == 'naver' %}
                                        <a href="https://sell.smartstore.naver.com/o/v3/manage/order/popup/{{ item.order_number }}/productOrderDetail" target="_blank">
                                            {{ item.order_number }}
                                        </a>
                                    {% else %}
                                        <a href="#" class="open-modal" data-item-id="{{ item.id }}">
                                            {{ item.order_number }}
                                        </a>
                                    {% endif %}
                                </td>
                                <td>{{ item.store_name|default:"N/A" }}</td>
                                <td>{{ item.recipient_name|default:"N/A" }}</td>
                                <td>{{ item.recipient_contact|default:"N/A" }}</td>
                                <td>{{ item.option_code|default:"N/A" }}</td>
                                <td>{{ item.product_name|default:"N/A" }}</td>
                                <td>{{ item.option_name|default:"N/A" }}</td>
                                <td>{{ item.quantity|default:"0" }}</td>
                                <td>{{ item.delivered_date }}</td>
                                <td>{{ item.claim_request_date|date:"Y년 m월 d일 A g:i" }}</td>
                                <td>{{ item.inspected_at|date:"Y년 m월 d일 A g:i" }}</td>

                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="16" class="text-center">데이터가 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 상세 모달 -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" style="max-height:80%;">
        <div class="modal-content" style="max-height:80%; overflow-y:auto;">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="detailModalLabel">상세 정보</h1>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-3">검수 결과</dt>
                    <dd class="col-sm-9" id="modal_product_issue"></dd>
                    <dt class="col-sm-3">클레임 사유</dt>
                    <dd class="col-sm-9" id="modal_claim_reason"></dd>
                    <dt class="col-sm-3">고객 사유</dt>
                    <dd class="col-sm-9" id="modal_customer_reason"></dd>
                    <dt class="col-sm-3">특이사항</dt>
                    <dd class="col-sm-9" id="modal_note"></dd>
                    <dt class="col-sm-3">수거 송장번호</dt>
                    <dd class="col-sm-9" id="modal_collect_tracking_number"></dd>
                    <dt class="col-sm-3">수거 배송비</dt>
                    <dd class="col-sm-9" id="modal_return_shipping_charge"></dd>
                    <dt class="col-sm-3">배송비 지급 방식</dt>
                    <dd class="col-sm-9" id="modal_shipping_charge_payment_method"></dd>
                    <dt class="col-sm-3">주문번호</dt>
                    <dd class="col-sm-9" id="modal_order_number"></dd>
                    <dt class="col-sm-3">스토어명</dt>
                    <dd class="col-sm-9" id="modal_store_name"></dd>
                    <dt class="col-sm-3">수취인명</dt>
                    <dd class="col-sm-9" id="modal_recipient_name"></dd>
                    <dt class="col-sm-3">연락처</dt>
                    <dd class="col-sm-9" id="modal_recipient_contact"></dd>
                    <dt class="col-sm-3">옵션코드</dt>
                    <dd class="col-sm-9" id="modal_option_code"></dd>
                    <dt class="col-sm-3">상품명</dt>
                    <dd class="col-sm-9" id="modal_product_name"></dd>
                    <dt class="col-sm-3">옵션명</dt>
                    <dd class="col-sm-9" id="modal_option_name"></dd>
                    <dt class="col-sm-3">수량</dt>
                    <dd class="col-sm-9" id="modal_quantity"></dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 교환 재배송 모달 -->
<div class="modal fade" id="exchangeDispatchModal" tabindex="-1" aria-labelledby="exchangeDispatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exchangeDispatchModalLabel">교환 재배송 처리</h5>
          <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="exchangeDispatchForm">
            <!-- 재배송 방법 -->
            <div class="mb-3">
              <label for="reDeliveryMethod" class="form-label fw-bold">재배송 방법</label>
              <select class="form-select" id="reDeliveryMethod">
                <option value="DELIVERY">택배, 등기, 소포</option>
                <option value="GDFW_ISSUE_SVC">굿스플로 송장 출력</option>
                <option value="VISIT_RECEIPT">방문 수령</option>
                <option value="DIRECT_DELIVERY">직접 전달</option>
                <option value="QUICK_SVC">퀵서비스</option>
                <option value="NOTHING">배송 없음</option>
                <option value="RETURN_DESIGNATED">지정 반품 택배</option>
                <option value="RETURN_DELIVERY">일반 반품 택배</option>
                <option value="RETURN_INDIVIDUAL">직접 반송</option>
                <option value="RETURN_MERCHANT">판매자 직접 수거</option>
                <option value="UNKNOWN">알 수 없음(예외 처리)</option>
              </select>
            </div>
            <!-- 택배사 (기본 CJGLS로 설정) -->
            <div class="mb-3">
              <label for="reDeliveryCompany" class="form-label fw-bold">택배사</label>
              <select class="form-select" id="reDeliveryCompany">
                <!-- 기본값 selected -->
                <option value="CJGLS" selected>CJ대한통운</option>
                <option value="KDEXP">경동택배</option>
                <option value="CHUNIL">천일택배</option>
              </select>
            </div>
            <!-- 운송장 번호 입력 -->
            <div class="mb-3">
              <label for="reDeliveryTrackingNumber" class="form-label fw-bold">재배송 송장 번호</label>
              <input type="text" class="form-control" id="reDeliveryTrackingNumber" placeholder="송장 번호를 입력하세요">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button type="button" class="btn btn-primary" id="exchangeDispatchSubmit">확인</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Member ID 입력 모달 (Bootstrap 5) -->
<div class="modal fade" id="memberIdModal" tabindex="-1" aria-labelledby="memberIdModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="memberIdModalLabel">Member ID 입력</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <p>새 창에서 스마트스토어 페이지를 확인한 후, memberId를 입력하세요:</p>
          <input type="text" id="memberIdInput" class="form-control" placeholder="Member ID 입력">
        </div>
        <div class="modal-footer">
          <button type="button" id="memberIdConfirm" class="btn btn-primary">확인</button>
        </div>
      </div>
    </div>
  </div>
<script>

    const updateStatusBtn = document.getElementById('update-product-order-status');
    updateStatusBtn.addEventListener('click', () => {

        // 전체 데이터에 대해 업데이트하므로 체크 여부는 묻지 않음
        // 필요한 경우 요청 시 특정 action으로 분기할 수 있도록 백엔드에서도 처리 필요
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ action: 'update_all_claim_status' })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showTemporaryMessage(`현재 클레임 상태 업데이트 완료: ${data.updated_count}개 항목`);
                setTimeout(() => {
                    location.reload();
                }, 1100);
            } else {
                showTemporaryMessage(`현재 클레임 상태 업데이트 실패: ${data.message || '알 수 없는 오류'}`);
            }
        })
        .catch(err => {
            console.error('요청 오류:', err);
            showTemporaryMessage(`요청 중 오류 발생: ${err.message}`);
        });
    });

    // 1) updateSelectedCount 함수 추가
    function updateSelectedCount() {
        const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
        const selectedCountEl = document.getElementById('selected-count');
        if (selectedCountEl) {
            selectedCountEl.textContent = checkedCount;
        }
    }

    // 전체 선택 체크박스 기능
    document.getElementById('select-all').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#items-table tbody input[type="checkbox"]');
        for (let checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
    });

    // 2) 행 클릭 시 체크박스 토글
    const rows = document.querySelectorAll('#items-table tbody tr');
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            if (e.target.tagName.toLowerCase() !== 'input' && !e.target.classList.contains('order-number-cell')) {
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    // 토글
                    checkbox.checked = !checkbox.checked;
                    // (B) 행 클릭 후, 개수 갱신
                    updateSelectedCount();
                }
            }
        });
    });

    // 3) 개별 체크박스 직접 클릭 시에도 개수 갱신
    //    (즉, 행 안의 체크박스를 직접 클릭한 경우도 카운트가 맞도록)
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    rowCheckboxes.forEach(chk => {
        chk.addEventListener('change', updateSelectedCount);
    });

    const issueFilter = document.getElementById('issue-filter');
    const reasonFilter = document.getElementById('reason-filter');
    const claimTypeFilter = document.getElementById('claim-type-filter');

    function filterRows() {
        const issueValue = issueFilter.value.trim();
        const reasonValue = reasonFilter.value.trim();
        const claimTypeValue = claimTypeFilter.value.trim();

        rows.forEach(row => {
            // "검수 결과"는 .issue-cell,
            // "클레임 사유"는 .reason-cell,
            // "클레임 종류"는 data-claim_type 속성에서 가져올 수 있습니다.

            const issueText = row.querySelector('.issue-cell')?.textContent.trim() || '';
            const reasonText = row.querySelector('.reason-cell')?.textContent.trim() || '';
            const rowClaimType = row.getAttribute('data-claim_type')?.trim() || '';

            let showRow = true;

            // 검수 결과 필터
            if (issueValue !== '' && issueText !== issueValue) {
                showRow = false;
            }
            // 클레임 사유 필터
            if (reasonValue !== '' && reasonText !== reasonValue) {
                showRow = false;
            }
            // 클레임 종류 필터
            if (claimTypeValue !== '' && rowClaimType !== claimTypeValue) {
                showRow = false;
            }

            // 최종 결과에 따라 표시/숨김
            row.style.display = showRow ? '' : 'none';
        });
    }

    // 세 개 필터의 change 이벤트마다 filterRows를 실행
    issueFilter.addEventListener('change', filterRows);
    reasonFilter.addEventListener('change', filterRows);
    claimTypeFilter.addEventListener('change', filterRows);

    // 페이지 로드 후 초기 호출
    filterRows();

    const applyReasonBtn = document.getElementById('apply-reason');
    const inputNote = document.getElementById('input-note');
    const reasonButtons = document.querySelectorAll('.reason-btn');

    let selectedIssue = null;

    function showTemporaryMessage(msg, duration = 1000) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '9999';
        alertDiv.textContent = msg;
        document.body.appendChild(alertDiv);
        setTimeout(() => {
            alertDiv.remove();
        }, duration);
    }

    function getCheckedIds() {
        const checkedRows = [];
        document.querySelectorAll('.row-checkbox:checked').forEach(chk => {
            checkedRows.push(chk.value);
        });
        return checkedRows;
    }

    function getCheckedRows() {
        return Array.from(document.querySelectorAll('.row-checkbox:checked')).map(chk => chk.closest('tr'));
    }

    // 검수 결과 업데이트
    reasonButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            selectedIssue = btn.getAttribute('data-reason');
            reasonButtons.forEach(b => b.classList.remove('btn-primary'));
            btn.classList.add('btn-primary');
            const checkedIds = getCheckedIds();
            if (checkedIds.length === 0) {
                showTemporaryMessage('체크한 항목이 없습니다.');
                return;
            }

            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'update_issue',
                    ids: checkedIds,
                    product_issue: selectedIssue
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showTemporaryMessage('검수 결과 업데이트 완료');
                    setTimeout(() => {
                        location.reload();
                    }, 1100);
                } else {
                    showTemporaryMessage('업데이트 실패');
                }
            });
        });
    });

    // 노트(특이사항) 일괄 적용
    applyReasonBtn.addEventListener('click', () => {
        const checkedIds = getCheckedIds();
        if (checkedIds.length === 0) {
            showTemporaryMessage('체크한 항목이 없습니다.');
            return;
        }

        fetch("{% url 'scan_submit' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'update_note',
                ids: checkedIds,
                note: inputNote.value.trim()
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showTemporaryMessage('사유(특이사항) 업데이트 완료');
                setTimeout(() => {
                    location.reload();
                }, 1100);
            } else {
                showTemporaryMessage('업데이트 실패');
            }
        });
    });
    const backToCollectedBtn = document.getElementById('back-to-collected-btn');
    backToCollectedBtn.addEventListener('click', () => {
        const checkedIds = getCheckedIds();  // 이미 정의된 함수로 체크된 item id 배열 가져오기
        if (checkedIds.length === 0) {
            showTemporaryMessage('체크한 항목이 없습니다.');
            return;
        }

        // 서버로 POST 요청하여 선택된 아이템들의 상태를 "수거완료"로 변경
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'back_to_collected',
                ids: checkedIds
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showTemporaryMessage('수거완료 상태로 되돌리기 완료');
                setTimeout(() => {
                    location.reload();
                }, 1100);
            } else {
                showTemporaryMessage('업데이트 실패: ' + (data.message || '알 수 없는 오류'));
            }
        })
        .catch(err => {
            console.error(err);
            showTemporaryMessage('요청 중 오류 발생: ' + err.message);
        });
    });
    function showAlert(message, type='info', duration=3000) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerText = message;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, duration);
    }

    function decodeUnicode(str) {
        try {
            return decodeURIComponent(escape(str));
        } catch(e) {
            return str;
        }
    }

    const approveButton = document.getElementById('approve-return-btn');
    approveButton.addEventListener('click', function(e) {
        e.preventDefault();

        const checkedBoxes = document.querySelectorAll('input[name="item_ids"]:checked');
        if (checkedBoxes.length === 0) {
            showAlert('선택된 항목이 없습니다.', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        checkedBoxes.forEach(cb => formData.append('item_ids', cb.value));

        fetch("{% url '반품처리_bulk' %}", {
            method: 'POST',
            body: formData
        })
        .then(res => {
            if (!res.ok) {
                throw new Error(`서버 오류: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                showAlert(data.message || '반품승인이 완료되었습니다.', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1100);
            } else {
                let errorMsg = '반품승인 중 오류가 발생했습니다.\n';
                if (data.errors && data.errors.length > 0) {
                    data.errors.forEach(err => {
                        const decodedMessage = decodeUnicode(err.message);
                        errorMsg += `ID: ${err.id}, 오류: ${decodedMessage}\n`;
                    });
                } else {
                    errorMsg += (data.message || '');
                }
                showAlert(errorMsg, 'danger', 5000);
            }
        })
        .catch(err => {
            console.error('AJAX 요청 오류:', err);
            showAlert(`서버 통신 중 오류 발생: ${err.message}`, 'danger', 5000);
        });
    });

    const smsButton = document.getElementById('send-sms-btn');
    smsButton.addEventListener('click', function(e) {
        e.preventDefault();

        const password = prompt("암호를 입력해주세요:");
        if (password !== '0618') {
            showAlert('암호가 틀렸습니다.', 'danger');
            return; 
        }

        const checkedRows = getCheckedRows();
        if (checkedRows.length === 0) {
            showAlert('선택된 항목이 없습니다.', 'warning');
            return;
        }

        const directPayRows = checkedRows.filter(row => {
            const methodCell = row.querySelector('td:nth-child(6)');
            return methodCell && methodCell.textContent.trim() === '판매자에게 직접 송금';
        });

        if (directPayRows.length === 0) {
            showAlert('판매자에게 직접 송금 선택한 항목이 없습니다.', 'warning');
            return;
        }

        const smsData = directPayRows.map(row => {
            return {
                id: row.querySelector('.row-checkbox').value,
                store_name: row.querySelector('td:nth-child(8)')?.textContent.trim() || "N/A",
                return_shipping_charge: row.querySelector('td:nth-child(5)')?.textContent.trim() || "0",
                recipient_contact: row.querySelector('td:nth-child(10)')?.textContent.trim() || "N/A"
            }
        });

        fetch("/send_shipping_sms/", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ items: smsData })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showAlert('문자 발송 성공', 'success');
            } else {
                showAlert(`문자 발송 실패: ${data.message || ''}`, 'danger');
            }
        })
        .catch(err => {
            console.error('문자 발송 요청 오류:', err);
            showAlert(`문자 발송 요청 중 오류 발생: ${err.message}`, 'danger');
        });
    });

    // 주문번호 클릭 시 모달 표시
    document.addEventListener("DOMContentLoaded", function() {
        const orderNumberCells = document.querySelectorAll(".order-number-cell");
        const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));

        orderNumberCells.forEach(cell => {
            cell.addEventListener('click', function(event) {
                // 클릭한 셀의 부모 tr
                const row = this.closest('tr');
                if (!row) return;

                document.getElementById('modal_product_issue').textContent = row.dataset.product_issue;
                document.getElementById('modal_claim_reason').textContent = row.dataset.claim_reason;
                document.getElementById('modal_customer_reason').textContent = row.dataset.customer_reason;
                document.getElementById('modal_note').textContent = row.dataset.note;
                document.getElementById('modal_collect_tracking_number').textContent = row.dataset.collect_tracking_number;
                document.getElementById('modal_return_shipping_charge').textContent = row.dataset.return_shipping_charge;
                document.getElementById('modal_shipping_charge_payment_method').textContent = row.dataset.shipping_charge_payment_method;
                document.getElementById('modal_order_number').textContent = row.dataset.order_number;
                document.getElementById('modal_store_name').textContent = row.dataset.store_name;
                document.getElementById('modal_recipient_name').textContent = row.dataset.recipient_name;
                document.getElementById('modal_recipient_contact').textContent = row.dataset.recipient_contact;
                document.getElementById('modal_option_code').textContent = row.dataset.option_code;
                document.getElementById('modal_product_name').textContent = row.dataset.product_name;
                document.getElementById('modal_option_name').textContent = row.dataset.option_name;
                document.getElementById('modal_quantity').textContent = row.dataset.quantity;

                detailModal.show();
                event.stopPropagation();
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        let currentOrderNumber = null;

        // 모달 관련
        const exchangeDispatchModal = new bootstrap.Modal(document.getElementById('exchangeDispatchModal'));
        const exchangeDispatchSubmit = document.getElementById('exchangeDispatchSubmit');

        // "교환재배송" 버튼 (for 루프 밖에 있는 단일 버튼)
        const exchangeDispatchBtn = document.getElementById('exchange-dispatch-btn');

        // 체크된 행 가져오는 헬퍼
        function getCheckedRows() {
            return Array.from(document.querySelectorAll('.row-checkbox:checked'))
                .map(chk => chk.closest('tr'));
        }

        // 1) "교환재배송" 버튼 클릭 시
        exchangeDispatchBtn.addEventListener('click', () => {
            // 체크된 행 가져오기
            const checkedRows = getCheckedRows();
            if (checkedRows.length === 0) {
                alert('행을 선택하세요.');
                return;
            }
            if (checkedRows.length > 1) {
                alert('교환재배송 처리는 한 건씩만 가능합니다. 한 개만 선택해주세요.');
                return;
            }

            // 단 하나의 행
            const row = checkedRows[0];
            currentOrderNumber = row.getAttribute('data-order_number');
            console.log('[DEBUG] 선택한 order_number=', currentOrderNumber);

            // 모달 열기
            exchangeDispatchModal.show();
        });

        // 2) 모달에서 "확인" 버튼 클릭 -> 교환 재배송 요청
        exchangeDispatchSubmit.addEventListener('click', () => {
            const reDeliveryMethod = document.getElementById('reDeliveryMethod').value;
            const reDeliveryCompany = document.getElementById('reDeliveryCompany').value;
            const reDeliveryTrackingNumber = document.getElementById('reDeliveryTrackingNumber').value.trim();

            console.log('[DEBUG] 교환재배송 요청:',
                currentOrderNumber, reDeliveryMethod, reDeliveryCompany, reDeliveryTrackingNumber);

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'dispatch_exchange',
                    product_order_id: currentOrderNumber,
                    re_delivery_method: reDeliveryMethod,
                    re_delivery_company: reDeliveryCompany,
                    re_delivery_tracking_number: reDeliveryTrackingNumber
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('교환재배송 처리 성공: ' + data.message);
                } else {
                    alert('교환재배송 처리 실패: ' + data.message);
                }
                exchangeDispatchModal.hide();
            })
            .catch(err => {
                console.error(err);
                alert('요청 중 오류가 발생했습니다.');
                exchangeDispatchModal.hide();
            });
        });
    });

        function showTemporaryMessage(msg, duration=1500) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '9999';
        alertDiv.textContent = msg;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), duration);
        }

        /** 
         * "claim_type='N/A'" 인 레코드만 골라서 id를 배열로 반환 
         */
        function getCheckedIdsNAOnly() {
            const result = [];
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            checkedBoxes.forEach(chk => {
                const tr = chk.closest('tr');
                if (!tr) return;
                const claimType = tr.getAttribute('data-claim_type') || "";
                if (claimType === 'N/A') {
                // 체크박스의 value="{{ item.id }}"
                result.push(chk.value);
                }
            });
            console.log("=== [DEBUG] getCheckedIdsNAOnly =>", result);
            return result;
            }

        // (A) “클레임종류→RETURN” 버튼
        const btnReturn = document.getElementById('btn-claim-type-return');
        btnReturn.addEventListener('click', () => {
        const selectedIds = getCheckedIdsNAOnly();
        if (selectedIds.length === 0) {
            showTemporaryMessage("체크된 항목 중 'N/A'가 없습니다.");
            return;
        }
        // 서버로 fetch
        fetch("{% url 'update_claim_type' %}", {
            method: 'POST',
            headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({
            action: 'update_claim_type',
            claim_type: 'RETURN',
            ids: selectedIds
            })
        })
            .then(res => {
            if (!res.ok) {
                // 서버에서 HTML 에러 페이지 등 받으면 여기서 에러 처리
                throw new Error("서버 응답이 정상이 아님(HTTP " + res.status + ")");
            }
            return res.json(); // JSON 파싱
            })
            .then(data => {
            if (data.success) {
                showTemporaryMessage(`RETURN으로 ${data.updated_count}건 업데이트 완료`);
                setTimeout(() => location.reload(), 1200);
            } else {
                showTemporaryMessage(`업데이트 실패: ${data.message || '알 수 없는 오류'}`);
            }
            })
            .catch(err => {
            console.error(err);
            showTemporaryMessage(`요청 오류: ${err.message}`);
            });
        });

        // (B) “클레임종류→EXCHANGE” 버튼 (동일 로직, claim_type='EXCHANGE')
        const btnExchange = document.getElementById('btn-claim-type-exchange');
        btnExchange.addEventListener('click', () => {
        const selectedIds = getCheckedIdsNAOnly();
        if (selectedIds.length === 0) {
            showTemporaryMessage("체크된 항목 중 'N/A'가 없습니다.");
            return;
        }
        fetch("{% url 'update_claim_type' %}", {
            method: 'POST',
            headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({
            action: 'update_claim_type',
            claim_type: 'EXCHANGE',
            ids: selectedIds
            })
        })
            .then(res => {
            if (!res.ok) {
                throw new Error("서버 응답 문제(HTTP " + res.status + ")");
            }
            return res.json();
            })
            .then(data => {
            if (data.success) {
                showTemporaryMessage(`EXCHANGE로 ${data.updated_count}건 업데이트 완료`);
                setTimeout(() => location.reload(), 1200);
            } else {
                showTemporaryMessage(`업데이트 실패: ${data.message || '알 수 없는 오류'}`);
            }
            })
            .catch(err => {
            console.error(err);
            showTemporaryMessage(`요청 오류: ${err.message}`);
            });
        }); 
        const copyOrderNumbersBtn = document.getElementById('copy-order-numbers-btn');
    copyOrderNumbersBtn.addEventListener('click', () => {
        // 이미 정의된 헬퍼 getCheckedRows() 활용
        const checkedRows = getCheckedRows(); 
        if (checkedRows.length === 0) {
            showTemporaryMessage('체크한 항목이 없습니다.');
            return;
        }

        // data-order_number 속성값들을 모아서 쉼표로 구분
        const orderNumbers = checkedRows.map(row => row.dataset.order_number);
        const textToCopy = orderNumbers.join(', ');

        // 클립보드 복사
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                showTemporaryMessage(`복사 완료: ${textToCopy}`);
            })
            .catch(err => {
                console.error('클립보드 복사 실패:', err);
                showTemporaryMessage('클립보드 복사 실패');
            });
    });
    const exportExcelBtn = document.getElementById('export-excel-btn');
    exportExcelBtn.addEventListener('click', function() {
        const selectedIds = getCheckedIds();
        if (!selectedIds.length) {
            alert("체크한 항목이 없습니다.");
            return;
        }

        fetch("{% url 'inspected_export_excel' %}", {  // ★ URL 확인
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}', // CSRF 사용 시
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ids: selectedIds })
        })
        .then(res => {
            if (!res.ok) {
                throw new Error("서버 응답이 정상이 아님(HTTP " + res.status + ")");
            }
            return res.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "selected_items.xlsx";
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        })
        .catch(err => {
            console.error("엑셀 다운로드 오류:", err);
            alert("엑셀 다운로드 실패: " + err.message);
        });
    });
</script>

<style>
     :root {
        --primary-color: #6c5ce7;
        --secondary-color: #a29bfe;
        --background-color: #f8f9fa;
        --text-color: #2d3436;
        --border-color: #dfe6e9;
        --table-text-color: #2d3436;
        --table-background: #ffffff;
    }
    
    body {
        background-color: var(--background-color);
        color: var(--text-color);
    }
    
    .container-fluid {
        max-width: 1400px;
    }
    
    h2 {
        color: var(--primary-color);
        font-weight: bold;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
    }
    
    .card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        background-color: #ffffff;
        color: var(--text-color);
    }
    
    .table-responsive {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .table {
        border-collapse: separate;
        border-spacing: 0;
        background-color: var(--table-background);
        color: var(--table-text-color);
    }
    
    .table thead th {
        position: sticky;
        top: 0;
        background-color: var(--primary-color);
        color: white;
        z-index: 1;
        padding: 15px;
        white-space: nowrap;
    }
    
    .table tbody tr:nth-child(even) {
        background-color: rgba(108, 92, 231, 0.1);
    }
    
    .table tbody tr:hover {
        background-color: rgba(108, 92, 231, 0.2);
    }
    
    .table td,
    .table th {
        padding: 12px;
        vertical-align: middle;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 250px;
    }
    .table thead th:nth-child(7),
    .table tbody td:nth-child(7) {
        width: 200px !important;
        min-width: 400px !important;
    }
</style>
<script>
    document.addEventListener("DOMContentLoaded", function() {
      // 모달 HTML 요소가 로드된 후에 초기화
      var memberIdModalElement = document.getElementById('memberIdModal');
      if (!memberIdModalElement) {
        console.error("memberIdModal 요소를 찾을 수 없습니다.");
        return;
      }
      var memberIdModal = new bootstrap.Modal(memberIdModalElement);
  
      window.openTalkChat = function(orderNumber, storeName) {
        console.log("openTalkChat 호출됨. orderNumber:", orderNumber, "storeName:", storeName);
        // 스마트스토어 API 페이지 URL 구성
        var apiUrl = "https://sell.smartstore.naver.com/o/v3/oa/biztalk/" + orderNumber + "/";
        console.log("스마트스토어 API 호출 URL:", apiUrl);
        
        // 새 창으로 해당 페이지 열기 (브라우저 쿠키가 적용되어 로그인 상태 확인 가능)
        var apiWindow = window.open(apiUrl, "SmartStorePage", "width=1024,height=768");
        
        // 모달을 열어 사용자에게 memberId 입력을 요청
        memberIdModal.show();
        
        // "확인" 버튼 클릭 이벤트 처리 (중복 바인딩 방지)
        document.getElementById("memberIdConfirm").onclick = function() {
          var memberId = document.getElementById("memberIdInput").value.trim();
          if (!memberId) {
            alert("Member ID를 입력해주세요.");
            return;
          }
          var code = storeCodeMap[storeName];
          if (!code) {
            alert("지원되지 않는 스토어입니다.");
            return;
          }
          var finalLink = "https://partner.talk.naver.com/chat/ct/" + code + "/" + memberId + "?";
          console.log("최종 톡톡 링크:", finalLink);
          memberIdModal.hide(); // 모달 닫기
          window.open(finalLink, "_blank"); // 최종 톡톡 URL 새 창 열기
        };
      };
  
      // 기존에 사용 중인 storeCodeMap 선언 (글로벌 변수)
      window.storeCodeMap = {
        "니뜰리히": "wcsrr1",
        "수비다": "wce1wv",
        "노는개최고양": "w4g8ot",
        "아르빙": "w48val"
      };
    });
  </script>
  {% endblock %}
