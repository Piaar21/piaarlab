{% extends 'return_process_base.html' %}
{% load dict_extras %}
{% block content %}

<!-- 전역에 showTemporaryMessage 함수 선언 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    function getCheckedRows() {
      return Array.from(document.querySelectorAll('.row-checkbox:checked'))
                  .map(chk => chk.closest('tr'));
    }
    function getCheckedIds() {
      return getCheckedRows().map(tr => tr.getAttribute('data-item-id'));
    }
    function showTemporaryMessage(msg, duration = 1000) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
      alertDiv.style.zIndex = '9999';
      alertDiv.textContent = msg;
      document.body.appendChild(alertDiv);
      setTimeout(() => { alertDiv.remove(); }, duration);
    }
</script>

<div class="container-fluid mt-4">
    <h2 class="mb-4 text-primary">수거완료 목록</h2>

    <div class="d-flex align-items-center mb-3">
        <span class="ms-2">
            선택된 항목: <strong id="selected-count">0</strong>개
        </span>
        <div class="btn-group me-3">
            <button class="btn btn-outline-danger reason-btn" data-reason="오배송">오배송</button>
            <button class="btn btn-outline-success reason-btn" data-reason="이상없음">이상없음</button>
            <button class="btn btn-outline-warning reason-btn" data-reason="파손및불량">파손및불량</button>
            <button class="btn btn-outline-info reason-btn" data-reason="보류">보류</button>
        </div>
        
        <input type="text" class="form-control w-auto" id="input-note" placeholder="사유(특이사항) 입력">
        <button class="btn btn-primary ms-2" id="apply-reason">사유 일괄 적용</button>
        <!-- 새로운 버튼 추가 -->
        <button class="btn btn-warning ms-2 d-flex align-items-center" id="update-product-order-status">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">현재클레임상태 업데이트</span>
        </button>
        <button class="btn btn-info ms-2" id="btn-claim-type-return">클레임종류→RETURN</button>
        <button class="btn btn-info ms-2" id="btn-claim-type-exchange">클레임종류→EXCHANGE</button>
        <button class="btn btn-success ms-2 d-flex align-items-center" id="send-sellertool">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">셀러툴 전송</span>
        </button>
        <button class="btn btn-outline-secondary ms-2" id="btn-excel">Excel</button>

        <button class="btn btn-danger ms-2" id="delete-items">데이터 삭제</button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                <table class="table table-hover table-striped align-middle" id="items-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="check-all"></th>
                            <th>순번</th>
                            <th>톡톡</th>
                            <th>검수</th>
                            <th>사유</th>
                            <th>
                                수거 송장번호<br>
                                <input type="text" id="collect-tracking-filter" placeholder="필터">
                            </th>
                            <th>현재클레임상태</th>
                            <th>클레임 종류</th>
                            <th>클레임사유</th>
                            <th>고객사유</th>
                            <th>상품명</th>
                            <th>옵션명</th>
                            <th>수량</th>
                            <th class="sortable" style="cursor:pointer">
                                스토어명 <span class="sort-indicator"></span>
                              </th>
                            <th>수취인명</th>
                            <th>연락처</th>
                            <th>옵션코드</th>
                            <th>수거배송비</th>
                            <th>배송비지급방식</th>
                            <th>주문번호</th>
                            <th>검수자</th>
                            <th>배송완료일</th>
                            <th>클레임요청일</th>
                            <th>업데이트날짜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-item-id="{{ item.id }}"
                            data-claim_type="{{ item.claim_type|default:'N/A' }}"
                            data-order-number="{{ item.order_number }}"
                            data-store-name="{{ item.store_name }}"
                            data-product-issue="{{ item.product_issue|default:'' }}"
                            class="item-row">
                            <!-- 체크박스에 value 추가 -->
                            <td><input type="checkbox" class="row-checkbox" value="{{ item.id }}"></td>
                            <td>
                                <a href="#" class="row-number text-decoration-none text-primary fw-bold open-modal"
                                   data-item-id="{{ item.id }}">
                                    {{ forloop.counter }}
                                </a>
                            </td>
                            <td>
                                {% if item.store_name in store_code_map_keys %}
                                  <button type="button" 
                                          class="btn btn-primary talk-btn" 
                                          data-order="{{ item.order_number }}" 
                                          data-store="{{ item.store_name }}"
                                          onclick="openTalkChat('{{ item.order_number }}','{{ item.store_name }}')">
                                    톡톡하기
                                  </button>
                                {% else %}
                                  <span class="text-danger fw-bold">미지원</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.product_issue %}
                                    <span class="text-primary fw-bold">검수완료 ({{ item.product_issue }})</span>
                                {% else %}
                                    <span class="text-danger fw-bold">미검수</span>
                                {% endif %}
                            </td>
                            <td class="note-cell">{{ item.note|default:"N/A" }}</td>
                            <td class="collect-tracking">{{ item.collect_tracking_number|default:"N/A" }}</td>
                            <td class="product-order-status-cell">{{ item.product_order_status|default:"N/A" }}</td>
                            <td>{{ item.claim_type|default:"N/A" }}</td>
                            <td>{{ item.claim_reason|default:"N/A" }}</td>
                            <td>{{ item.customer_reason|default:"N/A" }}</td>
                            <td>{{ item.product_name|default:"N/A" }}</td>
                            <td>{{ item.option_name|default:"N/A" }}</td>
                            <td class="quantity-cell">{{ item.quantity|default:"0" }}</td>
                            <td>{{ item.store_name|default:"N/A" }}</td>
                            <td>{{ item.recipient_name|default:"N/A" }}</td>
                            <td>{{ item.recipient_contact|default:"N/A" }}</td>
                            <td>{{ item.option_code|default:"N/A" }}</td>
                            <td>{{ item.return_shipping_charge|default:"0" }}</td>
                            <td>{{ item.shipping_charge_payment_method|default:"N/A" }}</td>
                            <td class="order-number">
                                {% if item.platform|lower == 'naver' %}
                                    <a href="https://sell.smartstore.naver.com/o/v3/manage/order/popup/{{ item.order_number }}/productOrderDetail" target="_blank">
                                        {{ item.order_number }}
                                    </a>
                                {% else %}
                                    <a href="#" class="open-modal" data-item-id="{{ item.id }}">
                                        {{ item.order_number }}
                                    </a>
                                {% endif %}
                            </td>
                            <td>{{ item.inspector|default:"N/A" }}</td>
                            <td>{{ item.delivered_date }}</td>
                            <td>{{ item.claim_request_date|date:"Y년 m월 d일 A g:i" }}</td>
                            <td>{{ item.collected_at|date:"Y년 m월 d일 A g:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="23" class="text-center">데이터가 없습니다.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 상세 정보 모달 -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" style="max-height:80%; overflow-y:auto;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-primary" id="itemModalLabel">상세 정보</h5>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped">
                    <tbody id="modal-item-details"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 수량 수정 모달 -->
<div class="modal fade" id="quantityModal" tabindex="-1" aria-labelledby="quantityModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width:400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-primary" id="quantityModalLabel">수량 수정</h5>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="number" class="form-control" id="quantity-input" placeholder="새로운 수량 입력">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="save-quantity-btn">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- Member ID 입력 모달 (Bootstrap 5) -->
<div class="modal fade" id="memberIdModal" tabindex="-1" aria-labelledby="memberIdModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="memberIdModalLabel">Member ID 입력</h5>
          <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <p>새 창에서 스마트스토어 페이지를 확인한 후, memberId를 입력하세요:</p>
          <input type="text" id="memberIdInput" class="form-control" placeholder="Member ID 입력">
        </div>
        <div class="modal-footer">
          <button type="button" id="memberIdConfirm" class="btn btn-primary">확인</button>
        </div>
      </div>
    </div>
</div>

<!-- ====== Excel Import/Export 모달 ====== -->
<div class="modal fade" id="excelModal" tabindex="-1" aria-labelledby="excelModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width:500px;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="excelModalLabel">Excel 다운로드/업로드</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <button class="btn btn-primary w-100 mb-3" id="btn-download-excel">현재 테이블 다운로드</button>
          <div class="mb-2">
            <label for="excel-file-input" class="form-label">Excel 파일 선택</label>
            <input class="form-control" type="file" id="excel-file-input" accept=".xlsx,.xls">
          </div>
          <button class="btn btn-success w-100" id="btn-upload-excel">엑셀 업로드</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

<style>
    :root {
        --primary-color: #6c5ce7;
        --secondary-color: #a29bfe;
        --background-color: #f8f9fa;
        --text-color: #2d3436;
        --border-color: #dfe6e9;
        --table-text-color: #2d3436;
        --table-background: #ffffff;
    }

    body {
        background-color: var(--background-color);
        color: var(--text-color);
    }

    .container-fluid {
        max-width: 1400px;
    }

    h2 {
        color: var(--primary-color);
        font-weight: bold;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
    }

    .card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        background-color: #ffffff;
        color: var(--text-color);
    }

    .table-responsive {
        max-height: 70vh;
        overflow-y: auto;
        position: relative;

    }

    .table {
        border-collapse: separate;
        border-spacing: 0;
        background-color: var(--table-background);
        color: var(--table-text-color);
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: var(--primary-color);
        color: white;
        z-index: 1;
        padding: 15px;
        white-space: nowrap;
    }

    .table tbody tr:nth-child(even) {
        background-color: rgba(108, 92, 231, 0.1);
    }

    .table tbody tr:hover {
        background-color: rgba(108, 92, 231, 0.2);
    }

    .table td,
    .table th {
        padding: 12px;
        vertical-align: middle;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 250px;
    }

    #modal-item-details td {
        white-space: normal;
        max-width: none;
    }
    .table thead th:first-child,
    .table tbody td:first-child {
        position: sticky;
        left: 0;
        background-color: var(--table-background, #fff);
        z-index: 2;
    }
    .table thead th:first-child {
        z-index: 3;
    }
    #control-panel .btn {
        padding: .25rem .5rem;
        font-size: .875rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const applyReasonBtn = document.getElementById('apply-reason');
        const deleteItemsBtn = document.getElementById('delete-items');
        const updateStatusBtn = document.getElementById('update-product-order-status');
        const inputNote = document.getElementById('input-note');
        const reasonButtons = document.querySelectorAll('.reason-btn');
        const rows = document.querySelectorAll('#items-table tbody tr');
        const collectTrackingFilter = document.getElementById('collect-tracking-filter');
        const checkAll = document.getElementById('check-all');
    
        let selectedIssue = null;
        let currentEditItemId = null; // 수량 수정용
    
        // "선택된 항목" 개수 업데이트
        function updateSelectedCount() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            const selectedCountEl = document.getElementById('selected-count');
            if (selectedCountEl) {
                selectedCountEl.textContent = checkedCount;
            }
        }
    
        // 전체선택 체크박스
        checkAll.addEventListener('change', function() {
            const allRowCheckboxes = document.querySelectorAll('.row-checkbox');
            allRowCheckboxes.forEach(chk => {
                chk.checked = checkAll.checked;
            });
            updateSelectedCount();
        });
    
        // 행 클릭 시 체크박스 토글 + 개수 갱신
        rows.forEach(row => {
            row.addEventListener('click', function (e) {
                if (e.target.tagName.toLowerCase() !== 'input' &&
                    !e.target.classList.contains('quantity-cell') &&
                    !e.target.classList.contains('open-modal')) {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        updateSelectedCount();
                    }
                }
            });
        });
    
        // 개별 체크박스 직접 클릭 시 개수 갱신
        document.querySelectorAll('.row-checkbox').forEach(chk => {
            chk.addEventListener('change', updateSelectedCount);
        });
    
        // 필터 인풋 이벤트
        collectTrackingFilter.addEventListener('input', function () {
            const filterValue = this.value.trim().toLowerCase();
            rows.forEach(row => {
                const ctCell = row.querySelector('.collect-tracking');
                if (!ctCell) return;
                const ctValue = ctCell.textContent.trim().toLowerCase();
                row.style.display = (filterValue === '' || ctValue.includes(filterValue)) ? '' : 'none';
            });
        });
    
        // 검수 상태 업데이트 (오배송, 이상없음, 파손및불량, 보류)
        reasonButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                selectedIssue = btn.getAttribute('data-reason');
                reasonButtons.forEach(b => b.classList.remove('btn-primary'));
                btn.classList.add('btn-primary');
    
                const checkedIds = getCheckedIds();
                if (checkedIds.length === 0) {
                    showTemporaryMessage('체크한 항목이 없습니다.');
                    return;
                }
    
                fetch("{% url 'scan_submit' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update_issue',
                        ids: checkedIds,
                        product_issue: selectedIssue
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const count = data.updated_count || 0;
                        showTemporaryMessage(`검수 상태 ${count}건 업데이트 완료`, 1500);
                        setTimeout(() => { location.reload(); }, 1600);
                    } else {
                        showTemporaryMessage(data.message || '업데이트 실패');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showTemporaryMessage('요청 오류 발생');
                });
            });
        });
    
        // 사유(특이사항) 일괄 적용
        applyReasonBtn.addEventListener('click', () => {
            const checkedIds = getCheckedIds();
            if (checkedIds.length === 0) {
                showTemporaryMessage('체크한 항목이 없습니다.');
                return;
            }
    
            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'update_note',
                    ids: checkedIds,
                    note: inputNote.value.trim()
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showTemporaryMessage('사유(특이사항) 업데이트 완료');
                    if (data.updated && Array.isArray(data.updated)) {
                        data.updated.forEach(item => {
                            const row = document.querySelector(`#items-table tbody tr[data-item-id="${item.id}"]`);
                            if (row) {
                                const noteCell = row.querySelector('.note-cell');
                                if (noteCell) {
                                    noteCell.textContent = item.note || "";
                                }
                            }
                        });
                    }
                } else {
                    showTemporaryMessage('업데이트 실패');
                }
            });
        });
    
        // 데이터 삭제 기능
        deleteItemsBtn.addEventListener('click', () => {
            const checkedIds = getCheckedIds();
            if (checkedIds.length === 0) {
                showTemporaryMessage('체크한 항목이 없습니다.');
                return;
            }
            if (!confirm('선택한 데이터를 정말 삭제하시겠습니까?')) {
                return;
            }
    
            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'delete_items',
                    ids: checkedIds,
                    product_issue: selectedIssue
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log(data.seller_tool_response);
                    showTemporaryMessage(`검수 상태 ${data.updated_count}건 업데이트 & 셀러툴 전송 완료`, 1500);
                    setTimeout(() => { location.reload(); }, 1600);
                } else {
                    showTemporaryMessage(data.message || '업데이트 실패');
                }
            })
            .catch(err => {
                console.error(err);
                showTemporaryMessage('요청 오류 발생');
            });
        });
    
        // 현재클레임상태 업데이트
        // 기존 변수, 이벤트 핸들러 초기화
        const spinner = updateStatusBtn.querySelector('.spinner-border');
        const btnText = updateStatusBtn.querySelector('.btn-text');

        updateStatusBtn.addEventListener('click', function() {
            // 로딩 시작
            spinner.classList.remove('d-none');
            btnText.textContent = '로딩 중...';
            updateStatusBtn.disabled = true;

            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: 'update_all_claim_status' })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('현재 클레임 상태 업데이트 완료: ' + data.updated_count + '개 항목');
                    location.reload();
                } else {
                    alert('현재 클레임 상태 업데이트 실패: ' + (data.message || '알 수 없는 오류'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('서버 응답이 올바르지 않습니다.');
            })
            .finally(() => {
                // 로딩 종료
                spinner.classList.add('d-none');
                btnText.textContent = '현재클레임상태 업데이트';
                updateStatusBtn.disabled = false;
            });
        });
    
        // 상세 정보 모달 열기
        document.querySelectorAll('.open-modal').forEach(el => {
            el.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const itemId = el.getAttribute('data-item-id');
                fetch("{% url 'scan_submit' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'get_details',
                        id: itemId
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) return;
                    const details = data.details;
                    const tbody = document.getElementById('modal-item-details');
                    tbody.innerHTML = '';

                    for (const key in details) {
                        const tr = document.createElement('tr');
                        const th = document.createElement('th');
                        th.textContent = key;
                        const td = document.createElement('td');

                        // 주문번호만 특별 처리
                        if (key === 'order_number') {
                        td.classList.add('editable-order-number');
                        td.textContent = details[key];
                        td.style.cursor = 'pointer';

                        td.addEventListener('click', function activateEditor() {
                            // 이미 input 열려있으면 무시
                            if (this.querySelector('input')) return;

                            const current = this.textContent.trim();
                            this.innerHTML = `<input type="text" class="form-control form-control-sm" value="${current}">`;
                            const input = this.querySelector('input');
                            input.focus();

                            const save = () => {
                            const newVal = input.value.trim();
                            if (!newVal || newVal === current) {
                                this.textContent = current;
                                return;
                            }
                            // 서버에 변경 요청
                            fetch("{% url 'scan_submit' %}", {
                                method: 'POST',
                                headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                action: 'update_order_number',
                                id: itemId,
                                order_number: newVal
                                })
                            })
                            .then(res => res.json())
                            .then(resp => {
                                if (resp.success) {
                                this.textContent = newVal;
                                // 목록 테이블(페이지 왼쪽)에도 반영하려면:
                                const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                                if (row) {
                                    row.setAttribute('data-order-number', newVal);
                                    row.querySelector('.order-number a').textContent = newVal;
                                }
                                } else {
                                alert('수정 실패: ' + (resp.message||''));
                                this.textContent = current;
                                }
                            })
                            .catch(() => {
                                alert('서버 오류');
                                this.textContent = current;
                            });
                            };

                            // Enter 또는 포커스 아웃 시 저장
                            input.addEventListener('keydown', e => {
                            if (e.key === 'Enter') save();
                            });
                            input.addEventListener('blur', save);
                            // 더 이상 중복 클릭 안 하도록 이벤트 제거
                            td.removeEventListener('click', activateEditor);
                        });
                        } else {
                        td.textContent = details[key];
                        }

                        tr.appendChild(th);
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    }

                    new bootstrap.Modal(document.getElementById('itemModal')).show();
                    });
            });
        });
    
        // 수량 수정 모달
        const quantityCells = document.querySelectorAll('.quantity-cell');
        const quantityModal = new bootstrap.Modal(document.getElementById('quantityModal'));
        const quantityInput = document.getElementById('quantity-input');
        const saveQuantityBtn = document.getElementById('save-quantity-btn');
    
        quantityCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                const tr = cell.closest('tr');
                currentEditItemId = tr.getAttribute('data-item-id');
                quantityInput.value = cell.textContent.trim();
                quantityModal.show();
            });
        });
    
        saveQuantityBtn.addEventListener('click', () => {
            const newQuantity = quantityInput.value.trim();
            if (newQuantity === '' || isNaN(newQuantity)) {
                showTemporaryMessage('유효한 수량을 입력하세요.');
                return;
            }
            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'update_quantity',
                    id: currentEditItemId,
                    new_quantity: parseInt(newQuantity, 10)
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showTemporaryMessage('수량 업데이트 완료');
                    setTimeout(() => { location.reload(); }, 1100);
                } else {
                    showTemporaryMessage('수량 업데이트 실패');
                }
            });
        });
        const storeHeader = document.querySelector('#items-table thead th.sortable');
        let storeAsc = true;  // true: 다음 클릭 때 오름차순, false면 내림차순
        storeHeader.addEventListener('click', () => {
        const tbody = document.querySelector('#items-table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        // 스토어명 컬럼이 몇 번째인지 구하기
        const idx = Array.from(storeHeader.parentNode.children).indexOf(storeHeader);

        rows.sort((a, b) => {
            const ta = a.children[idx].textContent.trim();
            const tb = b.children[idx].textContent.trim();
            return storeAsc
            ? ta.localeCompare(tb, 'ko')
            : tb.localeCompare(ta, 'ko');
        });

        // 정렬된 순서로 다시 붙이기
        rows.forEach(r => tbody.appendChild(r));

        // 화살표 표시 업데이트
        storeHeader.querySelector('.sort-indicator').textContent = storeAsc ? '▲' : '▼';
        storeAsc = !storeAsc;
        });
    });
    </script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
          // ====== 톡톡 채팅 오픈 & Modal ======
          var memberIdModalEl = document.getElementById('memberIdModal');
          if (memberIdModalEl) {
            var memberIdModal = new bootstrap.Modal(memberIdModalEl);
            window.openTalkChat = function(orderNumber, storeName) {
              console.log("openTalkChat:", orderNumber, storeName);
              var apiUrl = "https://sell.smartstore.naver.com/o/v3/oa/biztalk/" + orderNumber + "/";
              window.open(apiUrl, "SmartStorePage", "width=1024,height=768");
              memberIdModal.show();
              document.getElementById("memberIdConfirm").onclick = function() {
                var memberId = document.getElementById("memberIdInput").value.trim();
                if (!memberId) return alert("Member ID를 입력해주세요.");
                var code = storeCodeMap[storeName];
                if (!code) return alert("지원되지 않는 스토어입니다.");
                var finalLink = "https://partner.talk.naver.com/chat/ct/" + code + "/" + memberId + "?";
                console.log("최종 톡톡 링크:", finalLink);
                memberIdModal.hide();
                window.open(finalLink, "_blank");
              };
            };
          } else {
            console.error("memberIdModal 요소를 찾을 수 없습니다.");
          }
        
          // ====== 스토어 코드 맵 ======
          var storeCodeMap = {
            "니뜰리히": "wcsrr1",
            "수비다": "wce1wv",
            "노는개최고양": "w4g8ot",
            "아르빙": "w48val"
          };
        
          // ====== 'N/A'인 체크된 ID만 추출 ======
          function getCheckedIdsNAOnly() {
            var result = [];
            document.querySelectorAll('.row-checkbox:checked').forEach(function(chk) {
              var tr = chk.closest('tr');
              if (tr && tr.dataset.claim_type === 'N/A') {
                result.push(chk.value);
              }
            });
            console.log("getCheckedIdsNAOnly →", result);
            return result;
          }
        
          // ====== 클레임유형 변경 버튼 바인딩 ======
          function bindClaimButton(btnId, newType) {
            var btn = document.getElementById(btnId);
            if (!btn) return;
            btn.addEventListener('click', function() {
              var ids = getCheckedIdsNAOnly();
              if (!ids.length) return showTemporaryMessage("체크된 항목 중 'N/A'가 없습니다.");
              fetch("{% url 'update_claim_type' %}", {
                method: 'POST',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: 'update_claim_type', claim_type: newType, ids: ids })
              })
              .then(res => res.ok ? res.json() : Promise.reject("HTTP " + res.status))
              .then(data => {
                if (data.success) {
                  showTemporaryMessage(newType + "로 " + data.updated_count + "건 업데이트 완료");
                  setTimeout(() => location.reload(), 1200);
                } else {
                  showTemporaryMessage("업데이트 실패: " + (data.message||"알 수 없는 오류"));
                }
              })
              .catch(err => {
                console.error(err);
                showTemporaryMessage("요청 오류: " + err);
              });
            });
          }
          bindClaimButton('btn-claim-type-return', 'RETURN');
          bindClaimButton('btn-claim-type-exchange', 'EXCHANGE');
        
          // ====== 임시 메시지 표시 ======
          function showTemporaryMessage(msg) {
            var el = document.getElementById('temporaryMessage');
            if (!el) {
              el = document.createElement('div');
              el.id = 'temporaryMessage';
              el.style = 'position:fixed;top:20px;right:20px;background:rgba(0,0,0,0.7);color:#fff;padding:10px 20px;border-radius:4px;z-index:1000;';
              document.body.appendChild(el);
            }
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
          }
        
          // ====== 읽기 전용 컬럼 더블클릭 방지 ======
          var readonlyCols = [0,1,2,3,10,11,13,14,15,16,19,21,22,23];
          document.querySelectorAll('#items-table tbody tr').forEach(function(tr) {
            readonlyCols.forEach(function(idx) {
              var td = tr.cells[idx];
              if (!td) return;
              td.style.cursor = 'not-allowed';
              td.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                showTemporaryMessage('해당 열은 수정할 수 없습니다.');
              });
            });
          });
        
          // ====== Excel 모달 & 기능 ======
          var excelModalEl = document.getElementById('excelModal'),
              btnExcel      = document.getElementById('btn-excel'),
              btnDownload   = document.getElementById('btn-download-excel'),
              btnUpload     = document.getElementById('btn-upload-excel'),
              inputFile     = document.getElementById('excel-file-input'),
              table         = document.getElementById('items-table');
        
          if (!excelModalEl || !btnExcel || !btnDownload || !btnUpload || !inputFile || !table) {
            console.error('🛑 엑셀 관련 필수 요소(id) 누락');
          } else {
            var excelModal = new bootstrap.Modal(excelModalEl);
        
            btnExcel.addEventListener('click', () => excelModal.show());
        
            btnDownload.addEventListener('click', () => {
              var wb = XLSX.utils.book_new(),
                  ws = XLSX.utils.table_to_sheet(table, { raw:true });
              XLSX.utils.book_append_sheet(wb, ws, 'Data');
              XLSX.writeFile(wb, 'items.xlsx');
            });
        
            btnUpload.addEventListener('click', function() {
                if (!inputFile.files.length) return showTemporaryMessage('파일을 선택해주세요.');

                var fr = new FileReader();
                fr.onload = async function(evt) {
                    // 1) 엑셀 읽기
                    var wb    = XLSX.read(evt.target.result, { type:'binary' }),
                        sheet = wb.Sheets[wb.SheetNames[0]],
                        [hdrs, ...rows] = XLSX.utils.sheet_to_json(sheet, { header:1 });

                    // 2) 헤더별 인덱스 맵핑
                    var idx = {};
                    hdrs.forEach(function(h,j){
                    idx[h?.trim()] = j;
                    });

                    // 필수 헤더 체크
                    if (idx['주문번호'] == null) {
                    return showTemporaryMessage('헤더에 "주문번호"가 없습니다.');
                    }

                    // 3) Excel rows → payload (테이블이 아니라 rows[] 기준!)
                    var payload = rows.map(function(r, i) {
                    var orderNo = r[idx['주문번호']]?.toString().trim();
                    if (!orderNo) return null;  // 주문번호 없으면 스킵

                    var obj = { order_number: orderNo };

                    // 사유
                    if (idx['사유'] != null) {
                        var note = r[idx['사유']]?.toString().trim();
                        if (note) obj.note = note;
                    }
                    // 수량
                    if (idx['수량'] != null) {
                        var q = parseInt(r[idx['수량']], 10);
                        if (!isNaN(q)) obj.quantity = q;
                    }
                    // 클레임 종류
                    if (idx['클레임 종류'] != null) {
                        var ct = r[idx['클레임 종류']]?.toString().trim();
                        if (ct) obj.claim_type = ct;
                    }
                    // 고객사유
                    if (idx['고객사유'] != null) {
                        var cr = r[idx['고객사유']]?.toString().trim();
                        if (cr) obj.customer_reason = cr;
                    }
                          // 클레임사유
                    if (idx['클레임사유'] != null) {
                        var reason = (r[idx['클레임사유']]||'').toString().trim();
                        if (reason) obj.claim_reason = reason;
                    }
                    // 수거배송비
                    if (idx['수거배송비'] != null) {
                        var fee = parseFloat(r[idx['수거배송비']]);
                        if (!isNaN(fee)) obj.return_shipping_charge = fee;
                    }
                    // 배송비지급방식
                    if (idx['배송비지급방식'] != null) {
                        var pm = (r[idx['배송비지급방식']]||'').toString().trim();
                        if (pm) obj.shipping_charge_payment_method = pm;
                    }
                    
                    return obj;
                    })
                    .filter(x => x !== null);

                    // 4) 서버 전송
                    var csrftoken = document.cookie.match('(^|;)\\s*csrftoken=([^;]+)')?.pop() || '';
                    var res = await fetch('/collected/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ rows: payload })
                    });
                    var json = await res.json();
                    if (json.success) {
                    showTemporaryMessage('저장 성공, 새로고침 됩니다.');
                    setTimeout(() => location.reload(), 500);
                    } else {
                    showTemporaryMessage('서버 오류: ' + (json.error || '알 수 없음'));
                    }
                    excelModal.hide();
                };
                fr.readAsBinaryString(inputFile.files[0]);
                });

          }
        
          // ====== 셀러툴 전송 버튼 ======
        // "셀러툴 전송" 버튼 기능
        const sendBtn = document.getElementById('send-sellertool');
        const sendSpinner = sendBtn.querySelector('.spinner-border');
        const sendText = sendBtn.querySelector('.btn-text');
        sendBtn.addEventListener('click', function() {
            sendSpinner.classList.remove('d-none');
            sendText.textContent = '전송 중...';
            sendBtn.disabled = true;
            const selectedIds = getCheckedIds();
            if (!selectedIds.length) {
                showTemporaryMessage('체크한 항목이 없습니다.');
                sendSpinner.classList.add('d-none');
                sendText.textContent = '셀러툴 전송';
                sendBtn.disabled = false;
                return;
            }
            fetch("{% url 'send_return_items' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ids: selectedIds })
            })
            .then(res => res.json())
            .then(data => {
                const sc = data.success_count || 0;
                const fc = data.failure_count || 0;
                // 실패 메시지까지 보고 싶으면 error_message도 포함 가능
                if (fc > 0) {
                    showTemporaryMessage(`전송 완료: 성공 ${sc}건, 실패 ${fc}건\n오류: ${data.error_message || '없음'}`);
                } else {
                    showTemporaryMessage(`전송 완료: 성공 ${sc}건, 실패 ${fc}건`);
                }
            })
            .catch(err => {
                console.error(err);
                showTemporaryMessage('전송 오류 발생');
            })
            .finally(() => {
                sendSpinner.classList.add('d-none');
                sendText.textContent = '셀러툴 전송';
                sendBtn.disabled = false;
            });
        });
    });
        </script>
        

{% endblock %}
