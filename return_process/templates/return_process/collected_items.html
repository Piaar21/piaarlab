{% extends 'return_process_base.html' %}
{% load dict_extras %}
{% block content %}

<!-- ì „ì—­ì— showTemporaryMessage í•¨ìˆ˜ ì„ ì–¸ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    function getCheckedRows() {
      return Array.from(document.querySelectorAll('.row-checkbox:checked'))
                  .map(chk => chk.closest('tr'));
    }
    function getCheckedIds() {
      return getCheckedRows().map(tr => tr.getAttribute('data-item-id'));
    }
    function showTemporaryMessage(msg, duration = 1000) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
      alertDiv.style.zIndex = '9999';
      alertDiv.textContent = msg;
      document.body.appendChild(alertDiv);
      setTimeout(() => { alertDiv.remove(); }, duration);
    }
</script>

<div class="container-fluid mt-4">
    <h2 class="mb-4 text-primary">ìˆ˜ê±°ì™„ë£Œ ëª©ë¡</h2>

    <div class="d-flex align-items-center mb-3">
        <span class="ms-2">
            ì„ íƒëœ í•­ëª©: <strong id="selected-count">0</strong>ê°œ
        </span>
        <div class="btn-group me-3">
            <button class="btn btn-outline-danger reason-btn" data-reason="ì˜¤ë°°ì†¡">ì˜¤ë°°ì†¡</button>
            <button class="btn btn-outline-success reason-btn" data-reason="ì´ìƒì—†ìŒ">ì´ìƒì—†ìŒ</button>
            <button class="btn btn-outline-warning reason-btn" data-reason="íŒŒì†ë°ë¶ˆëŸ‰">íŒŒì†ë°ë¶ˆëŸ‰</button>
            <button class="btn btn-outline-info reason-btn" data-reason="ë³´ë¥˜">ë³´ë¥˜</button>
        </div>
        
        <input type="text" class="form-control w-auto" id="input-note" placeholder="ì‚¬ìœ (íŠ¹ì´ì‚¬í•­) ì…ë ¥">
        <button class="btn btn-primary ms-2" id="apply-reason">ì‚¬ìœ  ì¼ê´„ ì ìš©</button>
        <!-- ìƒˆë¡œìš´ ë²„íŠ¼ ì¶”ê°€ -->
        <button class="btn btn-warning ms-2 d-flex align-items-center" id="update-product-order-status">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">í˜„ì¬í´ë ˆì„ìƒíƒœ ì—…ë°ì´íŠ¸</span>
        </button>
        <button class="btn btn-info ms-2" id="btn-claim-type-return">í´ë ˆì„ì¢…ë¥˜â†’RETURN</button>
        <button class="btn btn-info ms-2" id="btn-claim-type-exchange">í´ë ˆì„ì¢…ë¥˜â†’EXCHANGE</button>
        <button class="btn btn-success ms-2 d-flex align-items-center" id="send-sellertool">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">ì…€ëŸ¬íˆ´ ì „ì†¡</span>
        </button>
        <button class="btn btn-outline-secondary ms-2" id="btn-excel">Excel</button>

        <button class="btn btn-danger ms-2" id="delete-items">ë°ì´í„° ì‚­ì œ</button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                <table class="table table-hover table-striped align-middle" id="items-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="check-all"></th>
                            <th>ìˆœë²ˆ</th>
                            <th>í†¡í†¡</th>
                            <th>ê²€ìˆ˜</th>
                            <th>ì‚¬ìœ </th>
                            <th>
                                ìˆ˜ê±° ì†¡ì¥ë²ˆí˜¸<br>
                                <input type="text" id="collect-tracking-filter" placeholder="í•„í„°">
                            </th>
                            <th>í˜„ì¬í´ë ˆì„ìƒíƒœ</th>
                            <th>í´ë ˆì„ ì¢…ë¥˜</th>
                            <th>í´ë ˆì„ì‚¬ìœ </th>
                            <th>ê³ ê°ì‚¬ìœ </th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ì˜µì…˜ëª…</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th class="sortable" style="cursor:pointer">
                                ìŠ¤í† ì–´ëª… <span class="sort-indicator"></span>
                              </th>
                            <th>ìˆ˜ì·¨ì¸ëª…</th>
                            <th>ì—°ë½ì²˜</th>
                            <th>ì˜µì…˜ì½”ë“œ</th>
                            <th>ìˆ˜ê±°ë°°ì†¡ë¹„</th>
                            <th>ë°°ì†¡ë¹„ì§€ê¸‰ë°©ì‹</th>
                            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                            <th>ê²€ìˆ˜ì</th>
                            <th>ë°°ì†¡ì™„ë£Œì¼</th>
                            <th>í´ë ˆì„ìš”ì²­ì¼</th>
                            <th>ì—…ë°ì´íŠ¸ë‚ ì§œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-item-id="{{ item.id }}"
                            data-claim_type="{{ item.claim_type|default:'N/A' }}"
                            data-order-number="{{ item.order_number }}"
                            data-store-name="{{ item.store_name }}"
                            data-product-issue="{{ item.product_issue|default:'' }}"
                            class="item-row">
                            <!-- ì²´í¬ë°•ìŠ¤ì— value ì¶”ê°€ -->
                            <td><input type="checkbox" class="row-checkbox" value="{{ item.id }}"></td>
                            <td>
                                <a href="#" class="row-number text-decoration-none text-primary fw-bold open-modal"
                                   data-item-id="{{ item.id }}">
                                    {{ forloop.counter }}
                                </a>
                            </td>
                            <td>
                                {% if item.store_name in store_code_map_keys %}
                                  <button type="button" 
                                          class="btn btn-primary talk-btn" 
                                          data-order="{{ item.order_number }}" 
                                          data-store="{{ item.store_name }}"
                                          onclick="openTalkChat('{{ item.order_number }}','{{ item.store_name }}')">
                                    í†¡í†¡í•˜ê¸°
                                  </button>
                                {% else %}
                                  <span class="text-danger fw-bold">ë¯¸ì§€ì›</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.product_issue %}
                                    <span class="text-primary fw-bold">ê²€ìˆ˜ì™„ë£Œ ({{ item.product_issue }})</span>
                                {% else %}
                                    <span class="text-danger fw-bold">ë¯¸ê²€ìˆ˜</span>
                                {% endif %}
                            </td>
                            <td class="note-cell">{{ item.note|default:"N/A" }}</td>
                            <td class="collect-tracking">{{ item.collect_tracking_number|default:"N/A" }}</td>
                            <td class="product-order-status-cell">{{ item.product_order_status|default:"N/A" }}</td>
                            <td>{{ item.claim_type|default:"N/A" }}</td>
                            <td>{{ item.claim_reason|default:"N/A" }}</td>
                            <td>{{ item.customer_reason|default:"N/A" }}</td>
                            <td>{{ item.product_name|default:"N/A" }}</td>
                            <td>{{ item.option_name|default:"N/A" }}</td>
                            <td class="quantity-cell">{{ item.quantity|default:"0" }}</td>
                            <td>{{ item.store_name|default:"N/A" }}</td>
                            <td>{{ item.recipient_name|default:"N/A" }}</td>
                            <td>{{ item.recipient_contact|default:"N/A" }}</td>
                            <td>{{ item.option_code|default:"N/A" }}</td>
                            <td>{{ item.return_shipping_charge|default:"0" }}</td>
                            <td>{{ item.shipping_charge_payment_method|default:"N/A" }}</td>
                            <td class="order-number">
                                {% if item.platform|lower == 'naver' %}
                                    <a href="https://sell.smartstore.naver.com/o/v3/manage/order/popup/{{ item.order_number }}/productOrderDetail" target="_blank">
                                        {{ item.order_number }}
                                    </a>
                                {% else %}
                                    <a href="#" class="open-modal" data-item-id="{{ item.id }}">
                                        {{ item.order_number }}
                                    </a>
                                {% endif %}
                            </td>
                            <td>{{ item.inspector|default:"N/A" }}</td>
                            <td>{{ item.delivered_date }}</td>
                            <td>{{ item.claim_request_date|date:"Yë…„ mì›” dì¼ A g:i" }}</td>
                            <td>{{ item.collected_at|date:"Yë…„ mì›” dì¼ A g:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="23" class="text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" style="max-height:80%; overflow-y:auto;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-primary" id="itemModalLabel">ìƒì„¸ ì •ë³´</h5>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped">
                    <tbody id="modal-item-details"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ìˆ˜ëŸ‰ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="quantityModal" tabindex="-1" aria-labelledby="quantityModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width:400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-primary" id="quantityModalLabel">ìˆ˜ëŸ‰ ìˆ˜ì •</h5>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="number" class="form-control" id="quantity-input" placeholder="ìƒˆë¡œìš´ ìˆ˜ëŸ‰ ì…ë ¥">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="save-quantity-btn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- Member ID ì…ë ¥ ëª¨ë‹¬ (Bootstrap 5) -->
<div class="modal fade" id="memberIdModal" tabindex="-1" aria-labelledby="memberIdModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="memberIdModalLabel">Member ID ì…ë ¥</h5>
          <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
        </div>
        <div class="modal-body">
          <p>ìƒˆ ì°½ì—ì„œ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ í˜ì´ì§€ë¥¼ í™•ì¸í•œ í›„, memberIdë¥¼ ì…ë ¥í•˜ì„¸ìš”:</p>
          <input type="text" id="memberIdInput" class="form-control" placeholder="Member ID ì…ë ¥">
        </div>
        <div class="modal-footer">
          <button type="button" id="memberIdConfirm" class="btn btn-primary">í™•ì¸</button>
        </div>
      </div>
    </div>
</div>

<!-- ====== Excel Import/Export ëª¨ë‹¬ ====== -->
<div class="modal fade" id="excelModal" tabindex="-1" aria-labelledby="excelModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width:500px;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="excelModalLabel">Excel ë‹¤ìš´ë¡œë“œ/ì—…ë¡œë“œ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
        </div>
        <div class="modal-body">
          <button class="btn btn-primary w-100 mb-3" id="btn-download-excel">í˜„ì¬ í…Œì´ë¸” ë‹¤ìš´ë¡œë“œ</button>
          <div class="mb-2">
            <label for="excel-file-input" class="form-label">Excel íŒŒì¼ ì„ íƒ</label>
            <input class="form-control" type="file" id="excel-file-input" accept=".xlsx,.xls">
          </div>
          <button class="btn btn-success w-100" id="btn-upload-excel">ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

<style>
    :root {
        --primary-color: #6c5ce7;
        --secondary-color: #a29bfe;
        --background-color: #f8f9fa;
        --text-color: #2d3436;
        --border-color: #dfe6e9;
        --table-text-color: #2d3436;
        --table-background: #ffffff;
    }

    body {
        background-color: var(--background-color);
        color: var(--text-color);
    }

    .container-fluid {
        max-width: 1400px;
    }

    h2 {
        color: var(--primary-color);
        font-weight: bold;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
    }

    .card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        background-color: #ffffff;
        color: var(--text-color);
    }

    .table-responsive {
        max-height: 70vh;
        overflow-y: auto;
        position: relative;

    }

    .table {
        border-collapse: separate;
        border-spacing: 0;
        background-color: var(--table-background);
        color: var(--table-text-color);
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: var(--primary-color);
        color: white;
        z-index: 1;
        padding: 15px;
        white-space: nowrap;
    }

    .table tbody tr:nth-child(even) {
        background-color: rgba(108, 92, 231, 0.1);
    }

    .table tbody tr:hover {
        background-color: rgba(108, 92, 231, 0.2);
    }

    .table td,
    .table th {
        padding: 12px;
        vertical-align: middle;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 250px;
    }

    #modal-item-details td {
        white-space: normal;
        max-width: none;
    }
    .table thead th:first-child,
    .table tbody td:first-child {
        position: sticky;
        left: 0;
        background-color: var(--table-background, #fff);
        z-index: 2;
    }
    .table thead th:first-child {
        z-index: 3;
    }
    #control-panel .btn {
        padding: .25rem .5rem;
        font-size: .875rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const applyReasonBtn = document.getElementById('apply-reason');
        const deleteItemsBtn = document.getElementById('delete-items');
        const updateStatusBtn = document.getElementById('update-product-order-status');
        const inputNote = document.getElementById('input-note');
        const reasonButtons = document.querySelectorAll('.reason-btn');
        const rows = document.querySelectorAll('#items-table tbody tr');
        const collectTrackingFilter = document.getElementById('collect-tracking-filter');
        const checkAll = document.getElementById('check-all');
    
        let selectedIssue = null;
        let currentEditItemId = null; // ìˆ˜ëŸ‰ ìˆ˜ì •ìš©
    
        // "ì„ íƒëœ í•­ëª©" ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateSelectedCount() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            const selectedCountEl = document.getElementById('selected-count');
            if (selectedCountEl) {
                selectedCountEl.textContent = checkedCount;
            }
        }
    
        // ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤
        checkAll.addEventListener('change', function() {
            const allRowCheckboxes = document.querySelectorAll('.row-checkbox');
            allRowCheckboxes.forEach(chk => {
                chk.checked = checkAll.checked;
            });
            updateSelectedCount();
        });
    
        // í–‰ í´ë¦­ ì‹œ ì²´í¬ë°•ìŠ¤ í† ê¸€ + ê°œìˆ˜ ê°±ì‹ 
        rows.forEach(row => {
            row.addEventListener('click', function (e) {
                if (e.target.tagName.toLowerCase() !== 'input' &&
                    !e.target.classList.contains('quantity-cell') &&
                    !e.target.classList.contains('open-modal')) {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        updateSelectedCount();
                    }
                }
            });
        });
    
        // ê°œë³„ ì²´í¬ë°•ìŠ¤ ì§ì ‘ í´ë¦­ ì‹œ ê°œìˆ˜ ê°±ì‹ 
        document.querySelectorAll('.row-checkbox').forEach(chk => {
            chk.addEventListener('change', updateSelectedCount);
        });
    
        // í•„í„° ì¸í’‹ ì´ë²¤íŠ¸
        collectTrackingFilter.addEventListener('input', function () {
            const filterValue = this.value.trim().toLowerCase();
            rows.forEach(row => {
                const ctCell = row.querySelector('.collect-tracking');
                if (!ctCell) return;
                const ctValue = ctCell.textContent.trim().toLowerCase();
                row.style.display = (filterValue === '' || ctValue.includes(filterValue)) ? '' : 'none';
            });
        });
    
        // ê²€ìˆ˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì˜¤ë°°ì†¡, ì´ìƒì—†ìŒ, íŒŒì†ë°ë¶ˆëŸ‰, ë³´ë¥˜)
        reasonButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                selectedIssue = btn.getAttribute('data-reason');
                reasonButtons.forEach(b => b.classList.remove('btn-primary'));
                btn.classList.add('btn-primary');
    
                const checkedIds = getCheckedIds();
                if (checkedIds.length === 0) {
                    showTemporaryMessage('ì²´í¬í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
    
                fetch("{% url 'scan_submit' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update_issue',
                        ids: checkedIds,
                        product_issue: selectedIssue
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const count = data.updated_count || 0;
                        showTemporaryMessage(`ê²€ìˆ˜ ìƒíƒœ ${count}ê±´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`, 1500);
                        setTimeout(() => { location.reload(); }, 1600);
                    } else {
                        showTemporaryMessage(data.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showTemporaryMessage('ìš”ì²­ ì˜¤ë¥˜ ë°œìƒ');
                });
            });
        });
    
        // ì‚¬ìœ (íŠ¹ì´ì‚¬í•­) ì¼ê´„ ì ìš©
        applyReasonBtn.addEventListener('click', () => {
            const checkedIds = getCheckedIds();
            if (checkedIds.length === 0) {
                showTemporaryMessage('ì²´í¬í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
    
            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'update_note',
                    ids: checkedIds,
                    note: inputNote.value.trim()
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showTemporaryMessage('ì‚¬ìœ (íŠ¹ì´ì‚¬í•­) ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    if (data.updated && Array.isArray(data.updated)) {
                        data.updated.forEach(item => {
                            const row = document.querySelector(`#items-table tbody tr[data-item-id="${item.id}"]`);
                            if (row) {
                                const noteCell = row.querySelector('.note-cell');
                                if (noteCell) {
                                    noteCell.textContent = item.note || "";
                                }
                            }
                        });
                    }
                } else {
                    showTemporaryMessage('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
            });
        });
    
        // ë°ì´í„° ì‚­ì œ ê¸°ëŠ¥
        deleteItemsBtn.addEventListener('click', () => {
            const checkedIds = getCheckedIds();
            if (checkedIds.length === 0) {
                showTemporaryMessage('ì²´í¬í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (!confirm('ì„ íƒí•œ ë°ì´í„°ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
    
            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'delete_items',
                    ids: checkedIds,
                    product_issue: selectedIssue
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log(data.seller_tool_response);
                    showTemporaryMessage(`ê²€ìˆ˜ ìƒíƒœ ${data.updated_count}ê±´ ì—…ë°ì´íŠ¸ & ì…€ëŸ¬íˆ´ ì „ì†¡ ì™„ë£Œ`, 1500);
                    setTimeout(() => { location.reload(); }, 1600);
                } else {
                    showTemporaryMessage(data.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
            })
            .catch(err => {
                console.error(err);
                showTemporaryMessage('ìš”ì²­ ì˜¤ë¥˜ ë°œìƒ');
            });
        });
    
        // í˜„ì¬í´ë ˆì„ìƒíƒœ ì—…ë°ì´íŠ¸
        // ê¸°ì¡´ ë³€ìˆ˜, ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
        const spinner = updateStatusBtn.querySelector('.spinner-border');
        const btnText = updateStatusBtn.querySelector('.btn-text');

        updateStatusBtn.addEventListener('click', function() {
            // ë¡œë”© ì‹œì‘
            spinner.classList.remove('d-none');
            btnText.textContent = 'ë¡œë”© ì¤‘...';
            updateStatusBtn.disabled = true;

            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: 'update_all_claim_status' })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('í˜„ì¬ í´ë ˆì„ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + data.updated_count + 'ê°œ í•­ëª©');
                    location.reload();
                } else {
                    alert('í˜„ì¬ í´ë ˆì„ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                // ë¡œë”© ì¢…ë£Œ
                spinner.classList.add('d-none');
                btnText.textContent = 'í˜„ì¬í´ë ˆì„ìƒíƒœ ì—…ë°ì´íŠ¸';
                updateStatusBtn.disabled = false;
            });
        });
    
        // ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ì—´ê¸°
        document.querySelectorAll('.open-modal').forEach(el => {
            el.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const itemId = el.getAttribute('data-item-id');
                fetch("{% url 'scan_submit' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'get_details',
                        id: itemId
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) return;
                    const details = data.details;
                    const tbody = document.getElementById('modal-item-details');
                    tbody.innerHTML = '';

                    for (const key in details) {
                        const tr = document.createElement('tr');
                        const th = document.createElement('th');
                        th.textContent = key;
                        const td = document.createElement('td');

                        // ì£¼ë¬¸ë²ˆí˜¸ë§Œ íŠ¹ë³„ ì²˜ë¦¬
                        if (key === 'order_number') {
                        td.classList.add('editable-order-number');
                        td.textContent = details[key];
                        td.style.cursor = 'pointer';

                        td.addEventListener('click', function activateEditor() {
                            // ì´ë¯¸ input ì—´ë ¤ìˆìœ¼ë©´ ë¬´ì‹œ
                            if (this.querySelector('input')) return;

                            const current = this.textContent.trim();
                            this.innerHTML = `<input type="text" class="form-control form-control-sm" value="${current}">`;
                            const input = this.querySelector('input');
                            input.focus();

                            const save = () => {
                            const newVal = input.value.trim();
                            if (!newVal || newVal === current) {
                                this.textContent = current;
                                return;
                            }
                            // ì„œë²„ì— ë³€ê²½ ìš”ì²­
                            fetch("{% url 'scan_submit' %}", {
                                method: 'POST',
                                headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                action: 'update_order_number',
                                id: itemId,
                                order_number: newVal
                                })
                            })
                            .then(res => res.json())
                            .then(resp => {
                                if (resp.success) {
                                this.textContent = newVal;
                                // ëª©ë¡ í…Œì´ë¸”(í˜ì´ì§€ ì™¼ìª½)ì—ë„ ë°˜ì˜í•˜ë ¤ë©´:
                                const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                                if (row) {
                                    row.setAttribute('data-order-number', newVal);
                                    row.querySelector('.order-number a').textContent = newVal;
                                }
                                } else {
                                alert('ìˆ˜ì • ì‹¤íŒ¨: ' + (resp.message||''));
                                this.textContent = current;
                                }
                            })
                            .catch(() => {
                                alert('ì„œë²„ ì˜¤ë¥˜');
                                this.textContent = current;
                            });
                            };

                            // Enter ë˜ëŠ” í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì €ì¥
                            input.addEventListener('keydown', e => {
                            if (e.key === 'Enter') save();
                            });
                            input.addEventListener('blur', save);
                            // ë” ì´ìƒ ì¤‘ë³µ í´ë¦­ ì•ˆ í•˜ë„ë¡ ì´ë²¤íŠ¸ ì œê±°
                            td.removeEventListener('click', activateEditor);
                        });
                        } else {
                        td.textContent = details[key];
                        }

                        tr.appendChild(th);
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    }

                    new bootstrap.Modal(document.getElementById('itemModal')).show();
                    });
            });
        });
    
        // ìˆ˜ëŸ‰ ìˆ˜ì • ëª¨ë‹¬
        const quantityCells = document.querySelectorAll('.quantity-cell');
        const quantityModal = new bootstrap.Modal(document.getElementById('quantityModal'));
        const quantityInput = document.getElementById('quantity-input');
        const saveQuantityBtn = document.getElementById('save-quantity-btn');
    
        quantityCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                const tr = cell.closest('tr');
                currentEditItemId = tr.getAttribute('data-item-id');
                quantityInput.value = cell.textContent.trim();
                quantityModal.show();
            });
        });
    
        saveQuantityBtn.addEventListener('click', () => {
            const newQuantity = quantityInput.value.trim();
            if (newQuantity === '' || isNaN(newQuantity)) {
                showTemporaryMessage('ìœ íš¨í•œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            fetch("{% url 'scan_submit' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'update_quantity',
                    id: currentEditItemId,
                    new_quantity: parseInt(newQuantity, 10)
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showTemporaryMessage('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    setTimeout(() => { location.reload(); }, 1100);
                } else {
                    showTemporaryMessage('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
            });
        });
        const storeHeader = document.querySelector('#items-table thead th.sortable');
        let storeAsc = true;  // true: ë‹¤ìŒ í´ë¦­ ë•Œ ì˜¤ë¦„ì°¨ìˆœ, falseë©´ ë‚´ë¦¼ì°¨ìˆœ
        storeHeader.addEventListener('click', () => {
        const tbody = document.querySelector('#items-table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        // ìŠ¤í† ì–´ëª… ì»¬ëŸ¼ì´ ëª‡ ë²ˆì§¸ì¸ì§€ êµ¬í•˜ê¸°
        const idx = Array.from(storeHeader.parentNode.children).indexOf(storeHeader);

        rows.sort((a, b) => {
            const ta = a.children[idx].textContent.trim();
            const tb = b.children[idx].textContent.trim();
            return storeAsc
            ? ta.localeCompare(tb, 'ko')
            : tb.localeCompare(ta, 'ko');
        });

        // ì •ë ¬ëœ ìˆœì„œë¡œ ë‹¤ì‹œ ë¶™ì´ê¸°
        rows.forEach(r => tbody.appendChild(r));

        // í™”ì‚´í‘œ í‘œì‹œ ì—…ë°ì´íŠ¸
        storeHeader.querySelector('.sort-indicator').textContent = storeAsc ? 'â–²' : 'â–¼';
        storeAsc = !storeAsc;
        });
    });
    </script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
          // ====== í†¡í†¡ ì±„íŒ… ì˜¤í”ˆ & Modal ======
          var memberIdModalEl = document.getElementById('memberIdModal');
          if (memberIdModalEl) {
            var memberIdModal = new bootstrap.Modal(memberIdModalEl);
            window.openTalkChat = function(orderNumber, storeName) {
              console.log("openTalkChat:", orderNumber, storeName);
              var apiUrl = "https://sell.smartstore.naver.com/o/v3/oa/biztalk/" + orderNumber + "/";
              window.open(apiUrl, "SmartStorePage", "width=1024,height=768");
              memberIdModal.show();
              document.getElementById("memberIdConfirm").onclick = function() {
                var memberId = document.getElementById("memberIdInput").value.trim();
                if (!memberId) return alert("Member IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                var code = storeCodeMap[storeName];
                if (!code) return alert("ì§€ì›ë˜ì§€ ì•ŠëŠ” ìŠ¤í† ì–´ì…ë‹ˆë‹¤.");
                var finalLink = "https://partner.talk.naver.com/chat/ct/" + code + "/" + memberId + "?";
                console.log("ìµœì¢… í†¡í†¡ ë§í¬:", finalLink);
                memberIdModal.hide();
                window.open(finalLink, "_blank");
              };
            };
          } else {
            console.error("memberIdModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        
          // ====== ìŠ¤í† ì–´ ì½”ë“œ ë§µ ======
          var storeCodeMap = {
            "ë‹ˆëœ°ë¦¬íˆ": "wcsrr1",
            "ìˆ˜ë¹„ë‹¤": "wce1wv",
            "ë…¸ëŠ”ê°œìµœê³ ì–‘": "w4g8ot",
            "ì•„ë¥´ë¹™": "w48val"
          };
        
          // ====== 'N/A'ì¸ ì²´í¬ëœ IDë§Œ ì¶”ì¶œ ======
          function getCheckedIdsNAOnly() {
            var result = [];
            document.querySelectorAll('.row-checkbox:checked').forEach(function(chk) {
              var tr = chk.closest('tr');
              if (tr && tr.dataset.claim_type === 'N/A') {
                result.push(chk.value);
              }
            });
            console.log("getCheckedIdsNAOnly â†’", result);
            return result;
          }
        
          // ====== í´ë ˆì„ìœ í˜• ë³€ê²½ ë²„íŠ¼ ë°”ì¸ë”© ======
          function bindClaimButton(btnId, newType) {
            var btn = document.getElementById(btnId);
            if (!btn) return;
            btn.addEventListener('click', function() {
              var ids = getCheckedIdsNAOnly();
              if (!ids.length) return showTemporaryMessage("ì²´í¬ëœ í•­ëª© ì¤‘ 'N/A'ê°€ ì—†ìŠµë‹ˆë‹¤.");
              fetch("{% url 'update_claim_type' %}", {
                method: 'POST',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: 'update_claim_type', claim_type: newType, ids: ids })
              })
              .then(res => res.ok ? res.json() : Promise.reject("HTTP " + res.status))
              .then(data => {
                if (data.success) {
                  showTemporaryMessage(newType + "ë¡œ " + data.updated_count + "ê±´ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
                  setTimeout(() => location.reload(), 1200);
                } else {
                  showTemporaryMessage("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + (data.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                }
              })
              .catch(err => {
                console.error(err);
                showTemporaryMessage("ìš”ì²­ ì˜¤ë¥˜: " + err);
              });
            });
          }
          bindClaimButton('btn-claim-type-return', 'RETURN');
          bindClaimButton('btn-claim-type-exchange', 'EXCHANGE');
        
          // ====== ì„ì‹œ ë©”ì‹œì§€ í‘œì‹œ ======
          function showTemporaryMessage(msg) {
            var el = document.getElementById('temporaryMessage');
            if (!el) {
              el = document.createElement('div');
              el.id = 'temporaryMessage';
              el.style = 'position:fixed;top:20px;right:20px;background:rgba(0,0,0,0.7);color:#fff;padding:10px 20px;border-radius:4px;z-index:1000;';
              document.body.appendChild(el);
            }
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
          }
        
          // ====== ì½ê¸° ì „ìš© ì»¬ëŸ¼ ë”ë¸”í´ë¦­ ë°©ì§€ ======
          var readonlyCols = [0,1,2,3,10,11,13,14,15,16,19,21,22,23];
          document.querySelectorAll('#items-table tbody tr').forEach(function(tr) {
            readonlyCols.forEach(function(idx) {
              var td = tr.cells[idx];
              if (!td) return;
              td.style.cursor = 'not-allowed';
              td.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                showTemporaryMessage('í•´ë‹¹ ì—´ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              });
            });
          });
        
          // ====== Excel ëª¨ë‹¬ & ê¸°ëŠ¥ ======
          var excelModalEl = document.getElementById('excelModal'),
              btnExcel      = document.getElementById('btn-excel'),
              btnDownload   = document.getElementById('btn-download-excel'),
              btnUpload     = document.getElementById('btn-upload-excel'),
              inputFile     = document.getElementById('excel-file-input'),
              table         = document.getElementById('items-table');
        
          if (!excelModalEl || !btnExcel || !btnDownload || !btnUpload || !inputFile || !table) {
            console.error('ğŸ›‘ ì—‘ì…€ ê´€ë ¨ í•„ìˆ˜ ìš”ì†Œ(id) ëˆ„ë½');
          } else {
            var excelModal = new bootstrap.Modal(excelModalEl);
        
            btnExcel.addEventListener('click', () => excelModal.show());
        
            btnDownload.addEventListener('click', () => {
              var wb = XLSX.utils.book_new(),
                  ws = XLSX.utils.table_to_sheet(table, { raw:true });
              XLSX.utils.book_append_sheet(wb, ws, 'Data');
              XLSX.writeFile(wb, 'items.xlsx');
            });
        
            btnUpload.addEventListener('click', function() {
                if (!inputFile.files.length) return showTemporaryMessage('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

                var fr = new FileReader();
                fr.onload = async function(evt) {
                    // 1) ì—‘ì…€ ì½ê¸°
                    var wb    = XLSX.read(evt.target.result, { type:'binary' }),
                        sheet = wb.Sheets[wb.SheetNames[0]],
                        [hdrs, ...rows] = XLSX.utils.sheet_to_json(sheet, { header:1 });

                    // 2) í—¤ë”ë³„ ì¸ë±ìŠ¤ ë§µí•‘
                    var idx = {};
                    hdrs.forEach(function(h,j){
                    idx[h?.trim()] = j;
                    });

                    // í•„ìˆ˜ í—¤ë” ì²´í¬
                    if (idx['ì£¼ë¬¸ë²ˆí˜¸'] == null) {
                    return showTemporaryMessage('í—¤ë”ì— "ì£¼ë¬¸ë²ˆí˜¸"ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    // 3) Excel rows â†’ payload (í…Œì´ë¸”ì´ ì•„ë‹ˆë¼ rows[] ê¸°ì¤€!)
                    var payload = rows.map(function(r, i) {
                    var orderNo = r[idx['ì£¼ë¬¸ë²ˆí˜¸']]?.toString().trim();
                    if (!orderNo) return null;  // ì£¼ë¬¸ë²ˆí˜¸ ì—†ìœ¼ë©´ ìŠ¤í‚µ

                    var obj = { order_number: orderNo };

                    // ì‚¬ìœ 
                    if (idx['ì‚¬ìœ '] != null) {
                        var note = r[idx['ì‚¬ìœ ']]?.toString().trim();
                        if (note) obj.note = note;
                    }
                    // ìˆ˜ëŸ‰
                    if (idx['ìˆ˜ëŸ‰'] != null) {
                        var q = parseInt(r[idx['ìˆ˜ëŸ‰']], 10);
                        if (!isNaN(q)) obj.quantity = q;
                    }
                    // í´ë ˆì„ ì¢…ë¥˜
                    if (idx['í´ë ˆì„ ì¢…ë¥˜'] != null) {
                        var ct = r[idx['í´ë ˆì„ ì¢…ë¥˜']]?.toString().trim();
                        if (ct) obj.claim_type = ct;
                    }
                    // ê³ ê°ì‚¬ìœ 
                    if (idx['ê³ ê°ì‚¬ìœ '] != null) {
                        var cr = r[idx['ê³ ê°ì‚¬ìœ ']]?.toString().trim();
                        if (cr) obj.customer_reason = cr;
                    }
                          // í´ë ˆì„ì‚¬ìœ 
                    if (idx['í´ë ˆì„ì‚¬ìœ '] != null) {
                        var reason = (r[idx['í´ë ˆì„ì‚¬ìœ ']]||'').toString().trim();
                        if (reason) obj.claim_reason = reason;
                    }
                    // ìˆ˜ê±°ë°°ì†¡ë¹„
                    if (idx['ìˆ˜ê±°ë°°ì†¡ë¹„'] != null) {
                        var fee = parseFloat(r[idx['ìˆ˜ê±°ë°°ì†¡ë¹„']]);
                        if (!isNaN(fee)) obj.return_shipping_charge = fee;
                    }
                    // ë°°ì†¡ë¹„ì§€ê¸‰ë°©ì‹
                    if (idx['ë°°ì†¡ë¹„ì§€ê¸‰ë°©ì‹'] != null) {
                        var pm = (r[idx['ë°°ì†¡ë¹„ì§€ê¸‰ë°©ì‹']]||'').toString().trim();
                        if (pm) obj.shipping_charge_payment_method = pm;
                    }
                    
                    return obj;
                    })
                    .filter(x => x !== null);

                    // 4) ì„œë²„ ì „ì†¡
                    var csrftoken = document.cookie.match('(^|;)\\s*csrftoken=([^;]+)')?.pop() || '';
                    var res = await fetch('/collected/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ rows: payload })
                    });
                    var json = await res.json();
                    if (json.success) {
                    showTemporaryMessage('ì €ì¥ ì„±ê³µ, ìƒˆë¡œê³ ì¹¨ ë©ë‹ˆë‹¤.');
                    setTimeout(() => location.reload(), 500);
                    } else {
                    showTemporaryMessage('ì„œë²„ ì˜¤ë¥˜: ' + (json.error || 'ì•Œ ìˆ˜ ì—†ìŒ'));
                    }
                    excelModal.hide();
                };
                fr.readAsBinaryString(inputFile.files[0]);
                });

          }
        
          // ====== ì…€ëŸ¬íˆ´ ì „ì†¡ ë²„íŠ¼ ======
        // "ì…€ëŸ¬íˆ´ ì „ì†¡" ë²„íŠ¼ ê¸°ëŠ¥
        const sendBtn = document.getElementById('send-sellertool');
        const sendSpinner = sendBtn.querySelector('.spinner-border');
        const sendText = sendBtn.querySelector('.btn-text');
        sendBtn.addEventListener('click', function() {
            sendSpinner.classList.remove('d-none');
            sendText.textContent = 'ì „ì†¡ ì¤‘...';
            sendBtn.disabled = true;
            const selectedIds = getCheckedIds();
            if (!selectedIds.length) {
                showTemporaryMessage('ì²´í¬í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                sendSpinner.classList.add('d-none');
                sendText.textContent = 'ì…€ëŸ¬íˆ´ ì „ì†¡';
                sendBtn.disabled = false;
                return;
            }
            fetch("{% url 'send_return_items' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ids: selectedIds })
            })
            .then(res => res.json())
            .then(data => {
                const sc = data.success_count || 0;
                const fc = data.failure_count || 0;
                // ì‹¤íŒ¨ ë©”ì‹œì§€ê¹Œì§€ ë³´ê³  ì‹¶ìœ¼ë©´ error_messageë„ í¬í•¨ ê°€ëŠ¥
                if (fc > 0) {
                    showTemporaryMessage(`ì „ì†¡ ì™„ë£Œ: ì„±ê³µ ${sc}ê±´, ì‹¤íŒ¨ ${fc}ê±´\nì˜¤ë¥˜: ${data.error_message || 'ì—†ìŒ'}`);
                } else {
                    showTemporaryMessage(`ì „ì†¡ ì™„ë£Œ: ì„±ê³µ ${sc}ê±´, ì‹¤íŒ¨ ${fc}ê±´`);
                }
            })
            .catch(err => {
                console.error(err);
                showTemporaryMessage('ì „ì†¡ ì˜¤ë¥˜ ë°œìƒ');
            })
            .finally(() => {
                sendSpinner.classList.add('d-none');
                sendText.textContent = 'ì…€ëŸ¬íˆ´ ì „ì†¡';
                sendBtn.disabled = false;
            });
        });
    });
        </script>
        

{% endblock %}
