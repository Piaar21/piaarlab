{% extends 'delayed_management_base.html' %}

{% block content %}
<div class="container-fluid mt-4">

  <h2 class="mb-4 text-primary">쿠팡 상품 리스트</h2>
  
  <!-- (1) 쿠팡 상품데이터 업데이트 버튼 -->
  <form action="{% url 'update_coupang_products' %}" method="POST" style="margin-top:20px;">
    {% csrf_token %}
    <button type="submit" class="btn btn-sm btn-primary">
      쿠팡 상품데이터 업데이트
    </button>
  </form>
  
  <hr>

  <!-- (2) 테이블: sellerProductId / vendorItemId / externalVendorSku / ... -->
  {% if products and products|length > 0 %}
  <div class="card mb-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th></th>
              <th>상품ID</th>
              <th>SKU ID</th>
              <th>custom ID</th>
              <th>구분</th>
              <th>상품명</th>
              <th>판매가(할인가)</th>
              <th>할인가</th>
              <th>개당이익금</th>
              <th>마켓 수수료</th>
              <th>입출고요금</th>
              <th>원가</th>
              <th>배송비</th>
              <th>상태</th>
            </tr>
          </thead>
          <tbody>
            {% for spid, data_dict in grouped_data.items %}
            {% with product_obj=data_dict.product %}
            <!-- 상위행 (상품) -->
            <tr class="product-row">
                <td>
                    <button class="btn btn-sm btn-outline-primary toggle-btn" data-spid="{{ spid }}">+</button>
                </td>
                <td>{{ spid }}</td>
                <!-- SKU ID -->
                <td>
                    {% with first_item=product_obj.items.first %}
                        {{ first_item.rocket_vendor_item_id|default:first_item.marketplace_vendor_item_id|default:"-" }}
                    {% endwith %}
                </td>

                <!-- Custom ID: externalVendorSku(첫 아이템) -->
                <td>
                  {% with first_item=product_obj.items.first %}
                      {{ first_item.rocket_external_vendor_sku|default:first_item.marketplace_external_vendor_sku|default:"-" }}
                  {% endwith %}
              </td>

                
                <td>{{ product_obj.delivery_label }}</td>
                <td>{{ product_obj.sellerProductName|default:"-" }}</td>
                <td>{{ product_obj.top_sale_price|floatformat:0 }} 원</td>
                <td>{{ product_obj.top_original_price|floatformat:0 }} 원</td>
                <td>{{ product_obj.top_profit|floatformat:0 }} 원</td>
                <td>{{ product_obj.top_fee|floatformat:0 }} 원</td>
                <td>
                    {% if product_obj.delivery_label == "로켓그로스" %}
                        1,072 원
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>-</td>
                <td>{{ product_obj.deliveryCharge }} 원</td>
                <td>
                    {% if product_obj.items.count > 0 %}
                        {% with fi=product_obj.items.first %}
                            {% if fi.rocket_maximum_buy_count|default:0 > 0 or fi.marketplace_maximum_buy_count|default:0 > 0 %}
                                <span class="text-success">판매중</span>
                            {% else %}
                                <span class="text-danger">품절</span>
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>

            <!-- 하위행들(옵션) -->
            {% for item_obj in product_obj.items.all %}
            <tr class="option-row" data-parent-id="{{ spid }}" style="display: none;">
                <td><i class="bi bi-star-fill text-warning"></i></td>
                <td>{{ spid }}</td>
                <td>{{ item_obj.rocket_vendor_item_id|default:item_obj.marketplace_vendor_item_id|default:"-" }}</td>
                <!-- Custom ID -->
                <td>{{ item_obj.rocket_external_vendor_sku|default:item_obj.marketplace_external_vendor_sku|default:"-" }}</td>

            
                
                <td>{{ item_obj.delivery_label }}</td>
                <td>{{ item_obj.itemName|default:"-" }}</td>
                <td>{{ item_obj.calc_sale_price|floatformat:0 }} 원</td>
                <td>{{ item_obj.calc_original_price|floatformat:0 }} 원</td>
                <td>{{ item_obj.calc_profit|floatformat:0 }} 원</td>
                <td>{{ item_obj.calc_fee|floatformat:0 }} 원</td>
                <td>
                    {% if item_obj.delivery_label == "로켓그로스" %}
                        1,072 원
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>-</td>
                <td>{{ product_obj.deliveryCharge }} 원</td>
                <td>
                    {% if item_obj.rocket_maximum_buy_count|default:0 > 0 or item_obj.marketplace_maximum_buy_count|default:0 > 0 %}
                        <span class="text-success">판매중</span>
                    {% else %}
                        <span class="text-danger">품절</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% endwith %}
            {% endfor %}

          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <div class="text-center text-muted mt-5">
    데이터가 없습니다.
  </div>
  {% endif %}

</div>

<!-- 스타일 -->
<style>
.container-fluid {
  max-width: 1400px;
}
.card {
  border: none;
  border-radius: 15px;
  background-color: #ffffff;
  color: #2d3436;
  padding: 20px;
}
.table thead th {
  background-color: #6c5ce7;
  color: white;
  position: sticky;
  top: 0;
  z-index: 10;
  white-space: nowrap;
}
.table tbody tr:nth-child(even) {
  background-color: rgba(108, 92, 231, 0.1);
}
.table tbody tr:hover {
  background-color: rgba(108, 92, 231, 0.2);
}
.table td, .table th {
  padding: 12px;
  vertical-align: middle;
  border-top: 1px solid #dfe6e9;
  border-bottom: 1px solid #dfe6e9;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}
.table-responsive {
  max-height: 70vh;
  overflow-y: auto;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const toggleButtons = document.querySelectorAll('.toggle-btn');
    toggleButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const spid = btn.dataset.spid;
        // 옵션 행들 중 data-parent-id=spid 인 것을 찾아 toggle
        const optionRows = document.querySelectorAll(`tr.option-row[data-parent-id="${spid}"]`);
        optionRows.forEach(row => {
          if (row.style.display === 'none') {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
        // + → - 아이콘 토글
        if (btn.textContent === '+') {
          btn.textContent = '-';
        } else {
          btn.textContent = '+';
        }
      });
    });
  });
  </script>

{% endblock %}
