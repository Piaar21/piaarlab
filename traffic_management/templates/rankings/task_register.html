<!-- templates/rankings/task_register.html -->

{% extends 'traffic_management_base.html' %}
{% load rankings_filters %}
{% block content %}
<div class="py-10 px-4">
    <h1 class="text-2xl font-bold mb-6">ì‘ì—… ë“±ë¡</h1>

    {% if formset.errors %}
        <div class="text-red-500 mb-4">
            {{ formset.errors }}
        </div>
    {% endif %}
    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
        {{ error }}
    </div>
    {% endif %}
    {% if success %}
        <div class="text-green-500 mb-4">ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
    {% elif error %}
        <div class="text-red-500 mb-4">ì‘ì—… ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
    {% endif %}
    <form method="post" action="">
        {% csrf_token %}
        <div class="overflow-x-auto" style="max-height: 70vh; overflow-y: auto;">
            <table id="task-table" class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">ë²ˆí˜¸</th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">ìƒí’ˆëª…</th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">ì¹´í…Œê³ ë¦¬</th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">
                            ìˆœìœ„ì¡°íšŒí‚¤ì›Œë“œ<br>(í•„ìˆ˜í‚¤ì›Œë“œ)
                            <span class="cursor-pointer text-yellow-500" onclick="openBulkInputModal('keyword')" title="ì¼ê´„ì…ë ¥">âš™ï¸</span>
                        </th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">
                            URL íƒ€ì…
                            <span class="cursor-pointer text-yellow-500" onclick="openBulkSelectModal('url_type')" title="ì¼ê´„ì„ íƒ">âš™ï¸</span>
                        </th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">
                            URL
                            <span class="cursor-pointer text-yellow-500" onclick="openBulkInputModal('url')" title="ì¼ê´„ì…ë ¥">âš™ï¸</span>
                        </th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">
                            ë©”ëª¨
                            <span class="cursor-pointer text-yellow-500" onclick="openBulkInputModal('memo')" title="ì¼ê´„ì…ë ¥">âš™ï¸</span>
                        </th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">
                            íŠ¸ë˜í”½ëª…
                            <span class="cursor-pointer text-yellow-500" onclick="openBulkSelectModal('traffic')" title="ì¼ê´„ì„ íƒ">âš™ï¸</span>
                        </th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">
                            ì´ìš©ê¶Œ ìˆ˜
                            <span class="cursor-pointer text-yellow-500" onclick="openBulkInputModal('ticket_count')" title="ì¼ê´„ì…ë ¥">âš™ï¸</span>
                        </th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">
                            ì´ìš©ê°€ëŠ¥<br>ì‹œì‘ì¼ì
                            <span class="cursor-pointer text-yellow-500" onclick="openBulkDateModal('available_start_date')" title="ì¼ê´„ì…ë ¥">ğŸ“…</span>
                        </th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">
                            ì´ìš©ê°€ëŠ¥<br>ì¢…ë£Œì¼ì
                            <span class="cursor-pointer text-yellow-500" onclick="openBulkDateModal('available_end_date')" title="ì¼ê´„ì…ë ¥">ğŸ“…</span>
                        </th>
                        <th class="px-4 py-2 sticky top-0 bg-gray-50">í–‰ ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="task-table-body" class="bg-white divide-y divide-gray-200">
                    {% for product in products %}
                    {% with data=initial_data|get_item:product.id %}
                    <tr data-product-id="{{ product.id }}" class="hover:bg-gray-100">
                        <td class="px-4 py-2 text-center">{{ forloop.counter }}</td>
                        <td class="px-4 py-2 text-center">
                            {{ product.name }}
                            <input type="hidden" name="product_name_{{ product.id }}" value="{{ product.name }}">
                            <input type="hidden" name="product_ids" value="{{ product.id }}">
                        </td>
                        <td class="px-4 py-2 text-center">
                            <input type="hidden" name="category_{{ product.id }}" value="ë„¤ì´ë²„">
                            ë„¤ì´ë²„
                        </td>
                        <td class="px-6 py-4 text-center">
                            <input type="text" name="keyword_{{ product.id }}" value="{{ data.keyword|default:'' }}" class="w-full px-2 py-1 border border-gray-300 rounded">
                        </td>
                        <td class="px-4 py-2 text-center">
                            <select name="url_type_{{ product.id }}" onchange="updateURL(this, {{ product.id }})" required data-single-url="{{ product.single_product_link }}" data-original-url="{{ product.original_link }}" class="w-full px-2 py-1 border border-gray-300 rounded bg-white">
                                <option value="">ì„ íƒ</option>
                                <option value="single" {% if data.url_type == 'single' %}selected{% endif %}>ë‹¨ì¼</option>
                                <option value="original" {% if data.url_type == 'original' %}selected{% endif %}>ì›ë¶€</option>
                            </select>
                        </td>
                        <td class="px-4 py-2 text-center">
                            <input type="url" id="url_{{ product.id }}" name="url_{{ product.id }}" value="{{ data.url|default:'' }}" required class="w-full px-2 py-1 border border-gray-300 rounded">
                        </td>
                        <td class="px-4 py-2 text-center">
                            <input type="text" name="memo_{{ product.id }}" value="{{ data.memo|default:'' }}" class="w-full px-2 py-1 border border-gray-300 rounded">
                        </td>
                        <td class="px-4 py-2 text-center">
                            <select name="traffic_{{ product.id }}" class="w-full px-2 py-1 border border-gray-300 rounded bg-white">
                                <option value="">ì„ íƒ</option>
                                {% for traffic in traffics %}
                                    <option value="{{ traffic.id }}" {% if data.traffic_id == traffic.id|stringformat:"s" %}selected{% endif %}>{{ traffic.name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="px-4 py-2 text-center">
                            <input type="number" name="ticket_count_{{ product.id }}" value="{{ data.ticket_count|default:'' }}" required class="w-full px-2 py-1 border border-gray-300 rounded">
                        </td>
                        <td class="px-4 py-2 text-center">
                            <input type="date" name="available_start_date_{{ product.id }}" value="{{ data.available_start_date|date:'Y-m-d' }}" required class="w-full px-2 py-1 border border-gray-300 rounded">
                        </td>
                        <td class="px-4 py-2 text-center">
                            <input type="date" name="available_end_date_{{ product.id }}" value="{{ data.available_end_date|date:'Y-m-d' }}" required class="w-full px-2 py-1 border border-gray-300 rounded">
                        </td>
                        <td class="px-4 py-2 text-center">
                            <button type="button" onclick="deleteRow(this)" class="text-red-500 hover:text-red-700">ì‚­ì œ</button>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-4 space-x-2">
            <button type="submit" name="register" value="register" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ë“±ë¡</button>
            <button type="button" onclick="setDateRange(9)" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">10ì¼</button>
            <button type="button" onclick="setDateRange(29)" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">30ì¼</button>
        </div>
    </form>

    <!-- ëª¨ë‹¬ êµ¬ì¡° (ì¼ë°˜ ì…ë ¥ìš©) -->
    <div id="bulkInputModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-sm w-full">
                <div class="px-4 py-3 border-b">
                    <h3 id="modalTitle" class="text-lg font-medium leading-6 text-gray-900">ì¼ê´„ ì…ë ¥</h3>
                    <span class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 cursor-pointer" onclick="closeModal()">&times;</span>
                </div>
                <div class="px-4 py-3">
                    <input type="text" id="bulkInputValue" class="w-full px-2 py-1 border border-gray-300 rounded">
                </div>
                <div class="px-4 py-3 border-t flex justify-end space-x-2">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ì·¨ì†Œ</button>
                    <button onclick="applyBulkInput()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ì¼ê´„ì…ë ¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ êµ¬ì¡° (Selectìš©) -->
    <div id="bulkSelectModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-sm w-full">
                <div class="px-4 py-3 border-b">
                    <h3 id="modalSelectTitle" class="text-lg font-medium leading-6 text-gray-900">ì¼ê´„ ì„ íƒ</h3>
                    <span class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 cursor-pointer" onclick="closeModal()">&times;</span>
                </div>
                <div class="px-4 py-3">
                    <select id="bulkSelectValue" class="w-full px-2 py-1 border border-gray-300 rounded bg-white">
                        <!-- ì˜µì…˜ì€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
                    </select>
                </div>
                <div class="px-4 py-3 border-t flex justify-end space-x-2">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ì·¨ì†Œ</button>
                    <button onclick="applyBulkSelect()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ì¼ê´„ì„ íƒ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ êµ¬ì¡° (ë‚ ì§œ ì„ íƒìš©) -->
    <div id="bulkDateModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-sm w-full">
                <div class="px-4 py-3 border-b">
                    <h3 id="modalDateTitle" class="text-lg font-medium leading-6 text-gray-900">ì¼ê´„ ì…ë ¥</h3>
                    <span class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 cursor-pointer" onclick="closeModal()">&times;</span>
                </div>
                <div class="px-4 py-3">
                    <input type="date" id="bulkDateValue" class="w-full px-2 py-1 border border-gray-300 rounded">
                </div>
                <div class="px-4 py-3 border-t flex justify-end space-x-2">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ì·¨ì†Œ</button>
                    <button onclick="applyBulkDate()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ì¼ê´„ì…ë ¥</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tailwind CSS ì¶”ê°€ -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<!-- jQuery ì¶”ê°€ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // JavaScript ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ë©°, ëª¨ë‹¬ì˜ í‘œì‹œ/ìˆ¨ê¹€ì„ ìœ„í•œ í´ë˜ìŠ¤ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.

    var currentFieldName = ''; // í˜„ì¬ ì„ íƒëœ í•„ë“œëª…

    // URL ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateURL(selectElement, productId) {
        var urlInput = document.getElementById('url_' + productId);
        var singleUrl = selectElement.getAttribute('data-single-url');
        var originalUrl = selectElement.getAttribute('data-original-url');

        if (selectElement.value === 'single') {
            urlInput.value = singleUrl || '';
        } else if (selectElement.value === 'original') {
            urlInput.value = originalUrl || '';
        } else {
            urlInput.value = '';
        }
    }

    // ë‚ ì§œ ë²”ìœ„ ì„¤ì • í•¨ìˆ˜
    function setDateRange(days) {
        var today = new Date();
        var startDate = new Date(today);
        startDate.setDate(today.getDate() + 1);  // ë‚´ì¼ë¶€í„° ì‹œì‘
        var endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + days);

        var startDateStr = startDate.toISOString().split('T')[0];
        var endDateStr = endDate.toISOString().split('T')[0];

        // ëª¨ë“  ìƒí’ˆì˜ ë‚ ì§œ í•„ë“œì— ì ìš©
        var rows = document.querySelectorAll('#task-table-body tr');
        rows.forEach(function(row) {
            var startDateInput = row.querySelector('input[name^="available_start_date_"]');
            var endDateInput = row.querySelector('input[name^="available_end_date_"]');
            startDateInput.value = startDateStr;
            endDateInput.value = endDateStr;
        });
    }

    // í–‰ ì‚­ì œ í•¨ìˆ˜
    function deleteRow(button) {
        var row = button.closest('tr');
        row.parentNode.removeChild(row);
    }

    // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (Inputìš©)
    function openBulkInputModal(fieldName) {
        currentFieldName = fieldName;
        document.getElementById('bulkInputValue').value = '';
        document.getElementById('modalTitle').innerText = fieldName + ' ì¼ê´„ ì…ë ¥';
        document.getElementById('bulkInputModal').classList.remove('hidden');
    }

    // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (Selectìš©)
    function openBulkSelectModal(fieldName) {
        currentFieldName = fieldName;
        var modalSelect = document.getElementById('bulkSelectValue');
        modalSelect.innerHTML = ''; // ê¸°ì¡´ ì˜µì…˜ ì œê±°

        // ì²« ë²ˆì§¸ í–‰ì—ì„œ ì˜µì…˜ì„ ê°€ì ¸ì˜´
        var firstRow = document.querySelector('#task-table-body tr');
        if (firstRow) {
            var select = firstRow.querySelector('select[name^="' + fieldName + '_"]');
            if (select) {
                // ì˜µì…˜ë“¤ì„ ë³µì‚¬í•˜ì—¬ ëª¨ë‹¬ì˜ selectì— ì¶”ê°€
                for (var i = 0; i < select.options.length; i++) {
                    var option = document.createElement('option');
                    option.value = select.options[i].value;
                    option.text = select.options[i].text;
                    modalSelect.add(option);
                }
            }
        }

        document.getElementById('modalSelectTitle').innerText = fieldName + ' ì¼ê´„ ì„ íƒ';
        document.getElementById('bulkSelectModal').classList.remove('hidden');
    }

    // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (Dateìš©)
    function openBulkDateModal(fieldName) {
        currentFieldName = fieldName;
        document.getElementById('bulkDateValue').value = '';
        document.getElementById('modalDateTitle').innerText = fieldName + ' ì¼ê´„ ì…ë ¥';
        document.getElementById('bulkDateModal').classList.remove('hidden');
    }

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeModal() {
        document.getElementById('bulkInputModal').classList.add('hidden');
        document.getElementById('bulkSelectModal').classList.add('hidden');
        document.getElementById('bulkDateModal').classList.add('hidden');
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«í˜
    window.onclick = function(event) {
        var bulkInputModal = document.getElementById('bulkInputModal');
        var bulkSelectModal = document.getElementById('bulkSelectModal');
        var bulkDateModal = document.getElementById('bulkDateModal');
        if (event.target == bulkInputModal) {
            bulkInputModal.classList.add('hidden');
        }
        if (event.target == bulkSelectModal) {
            bulkSelectModal.classList.add('hidden');
        }
        if (event.target == bulkDateModal) {
            bulkDateModal.classList.add('hidden');
        }
    }

    // ì¼ê´„ ì…ë ¥ ì ìš© í•¨ìˆ˜
    function applyBulkInput() {
    var value = document.getElementById('bulkInputValue').value;
    var rows = document.querySelectorAll('#task-table-body tr');
    rows.forEach(function(row) {
        var input = row.querySelector('input[name^="' + currentFieldName + '_"]');
        if (input) {
            input.value = value;
            input.focus(); // ì¼ê´„ ì…ë ¥ í›„ í•´ë‹¹ í•„ë“œë¡œ í¬ì»¤ìŠ¤
        }
    });
    closeModal();
}   

    // ì¼ê´„ ì„ íƒ ì ìš© í•¨ìˆ˜
    function applyBulkSelect() {
        var selectValue = document.getElementById('bulkSelectValue').value;
        var rows = document.querySelectorAll('#task-table-body tr');
        rows.forEach(function(row) {
            var select = row.querySelector('select[name^="' + currentFieldName + '_"]');
            if (select) {
                select.value = selectValue;
                if (currentFieldName === 'url_type') {
                    var productId = row.getAttribute('data-product-id');
                    updateURL(select, productId);
                }
            }
        });
        closeModal();
    }

    // ì¼ê´„ ë‚ ì§œ ì ìš© í•¨ìˆ˜
    function applyBulkDate() {
        var dateValue = document.getElementById('bulkDateValue').value;
        var rows = document.querySelectorAll('#task-table-body tr');
        rows.forEach(function(row) {
            var dateInput = row.querySelector('input[name^="' + currentFieldName + '_"]');
            if (dateInput) {
                dateInput.value = dateValue;
            }
        });
        closeModal();
    }

    document.addEventListener('DOMContentLoaded', function() {
        var taskData = sessionStorage.getItem('taskData');
        if (taskData) {
            taskData = JSON.parse(taskData);
            // taskDataë¥¼ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸”ì„ ë™ì ìœ¼ë¡œ ìƒì„±
            generateTaskTable(taskData);
            // ì‘ì—… ì™„ë£Œ í›„ sessionStorageì—ì„œ ë°ì´í„° ì‚­ì œ
            sessionStorage.removeItem('taskData');
        } else {
            // ì„œë²„ì—ì„œ ì „ë‹¬ëœ productsì™€ initial_dataë¥¼ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸”ì„ êµ¬ì„±
            // ì´ ë¶€ë¶„ì€ ì„œë²„ì—ì„œ ë Œë”ë§ë˜ë¯€ë¡œ ì¶”ê°€ ì‘ì—…ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
        }
    });

    function generateTaskTable(taskData) {
        var tbody = document.getElementById('task-table-body');
        taskData.forEach(function(data, index) {
            // ê° í–‰ì„ ìƒì„±í•˜ê³  ë°ì´í„° ì±„ìš°ê¸°
            // ìƒí’ˆëª…ìœ¼ë¡œ Productë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ í•„ìš”í•œ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            // ...
        });
    }
</script>
{% endblock %}
